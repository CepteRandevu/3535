<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Randevu Al</title>

<style>
  body {
    margin: 0;
    background: #020617;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #e5e7eb;
  }

  .topbar {
    background: rgba(15,23,42,0.98);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    box-shadow: 0 10px 30px rgba(15,23,42,0.9);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .back {
    margin-right: 10px;
    font-size: 20px;
    cursor: pointer;
    color: #9ca3af;
  }

  .title {
    font-size: 18px;
    font-weight: 600;
  }

  .container {
    padding: 18px 16px 24px;
  }

  label {
    display:block;
    font-size: 12px;
    color: #9ca3af;
    margin-bottom: 4px;
    margin-top: 10px;
  }

  select, input {
    width: 100%;
    padding: 11px 12px;
    margin-bottom: 4px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.4);
    background: rgba(15,23,42,0.9);
    color: #e5e7eb;
    font-size: 14px;
    outline: none;
  }

  select:focus, input:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 1px rgba(37,99,235,0.6);
  }

  button {
    width: 100%;
    margin-top: 14px;
    padding: 12px;
    background: linear-gradient(135deg,#2563eb,#4f46e5);
    color: white;
    border: none;
    border-radius: 999px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 14px 30px rgba(37,99,235,0.7);
  }

  button:active {
    transform: translateY(1px);
    box-shadow: 0 8px 18px rgba(37,99,235,0.8);
  }

  .hint {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 4px;
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="back" onclick="history.back()">←</div>
  <div class="title">Randevu Al</div>
</div>

<div class="container">

  <label for="serviceSelect">Hizmet</label>
  <select id="serviceSelect">
    <option value="">Hizmet seç</option>
  </select>

  <label for="workerSelect">Çalışan</label>
  <select id="workerSelect">
    <option value="">Çalışan seç</option>
  </select>

  <label for="customerName">Ad Soyad</label>
  <input id="customerName" type="text" placeholder="Adınız Soyadınız">

  <label for="date">Tarih</label>
  <input id="date" type="date">

  <label for="time">Saat</label>
  <input id="time" type="time">
  <div class="hint">Lütfen işletmenin çalışma saatlerine uygun bir zaman seçin.</div>

  <button onclick="createAppointment()">Randevu Oluştur</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
    authDomain: "cepterandevu-35fe4.firebaseapp.com",
    projectId: "cepterandevu-35fe4",
    storageBucket: "cepterandevu-35fe4.appspot.com",
    messagingSenderId: "86298180836",
    appId: "1:86298180836:web:ab05fbb0dcfbb56b2700f1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const params = new URLSearchParams(window.location.search);
  const businessId = params.get("id");

  let currentUser = null;

  if (!businessId) {
    alert("Geçersiz işletme bilgisi. Lütfen listeye geri dönüp tekrar deneyin.");
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Randevu alabilmek için önce giriş yapmalısınız.");
      window.location.href = "/3535/pages/user/user-login.html";
      return;
    }
    currentUser = user;
    loadServices();
    loadWorkers();
  });

  async function loadServices() {
    const sel = document.getElementById("serviceSelect");
    sel.innerHTML = '<option value="">Hizmet seç</option>';

    if (!businessId) return;

    const q = query(
      collection(db, "services"),
      where("businessId", "==", businessId)
    );
    const snap = await getDocs(q);

    snap.forEach((docSnap) => {
      const s = docSnap.data();
      sel.innerHTML += `<option value="${s.name}">${s.name} - ${s.price || ""}₺</option>`;
    });
  }

  async function loadWorkers() {
    const sel = document.getElementById("workerSelect");
    sel.innerHTML = '<option value="">Çalışan seç</option>';

    if (!businessId) return;

    const q = query(
      collection(db, "workers"),
      where("businessId", "==", businessId)
    );
    const snap = await getDocs(q);

    snap.forEach((docSnap) => {
      const w = docSnap.data();
      sel.innerHTML += `<option value="${w.name}">${w.name}</option>`;
    });
  }

  window.createAppointment = async function () {
    if (!currentUser) {
      alert("Randevu alabilmek için giriş yapmalısınız.");
      return;
    }

    const service = document.getElementById("serviceSelect").value;
    const worker = document.getElementById("workerSelect").value;
    const name = document.getElementById("customerName").value.trim();
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;

    if (!businessId) {
      alert("İşletme bilgisi eksik. Lütfen geri dönüp tekrar deneyin.");
      return;
    }

    if (!service || !worker || !name || !date || !time) {
      alert("Lütfen tüm alanları doldurun.");
      return;
    }

    await addDoc(collection(db, "appointments"), {
      businessId,
      serviceName: service,
      workerName: worker,
      customerId: currentUser.uid,
      customerName: name,
      date,
      time,
      status: "pending",
      createdAt: new Date()
    });

    alert("Randevu oluşturuldu!");
    window.location.href = "/3535/pages/user/user-panel.html";
  };
</script>

</body>
</html>
