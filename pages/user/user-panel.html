<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√º≈üteri Paneli | Cepte Randevu</title>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #0b1220;
      --card: #020617;
      --card-soft: #020617;
      --accent: #2563eb;
      --accent-soft: rgba(37,99,235,0.14);
      --accent-strong: #1d4ed8;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(148,163,184,0.22);
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 40%, #000 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    .shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 14px 16px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
      border-bottom: 1px solid rgba(30,64,175,0.5);
      box-shadow: 0 12px 40px rgba(15,23,42,0.9);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-badge {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #60a5fa, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 15px;
      color: white;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.85), 0 10px 26px rgba(37,99,235,0.9);
    }
    .brand-text {
      display: flex;
      flex-direction: column;
    }
    .brand-text span:first-child {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: .04em;
      text-transform: uppercase;
    }
    .brand-text span:last-child {
      font-size: 11px;
      color: var(--muted);
    }
    .user-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 11px;
      color: var(--muted);
      max-width: 140px;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    main {
      flex: 1;
      padding: 12px 12px 70px;
    }

    .section {
      display: none;
      animation: fadeIn .25s ease-out;
    }
    .section.active {
      display: block;
    }

    .hero {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.35), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(129,140,248,0.25), transparent 55%),
                  linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.94));
      border-radius: 22px;
      padding: 16px 15px 15px;
      border: 1px solid rgba(129,140,248,0.35);
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }
    .hero-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .16em;
      color: #a5b4fc;
      margin-bottom: 4px;
    }
    .hero-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .hero-sub {
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 10px;
    }
    .hero-row {
      display: flex;
      gap: 10px;
      font-size: 11px;
      color: #cbd5f5;
    }
    .hero-chip {
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(129,140,248,0.55);
    }
    .hero-badge {
      position: absolute;
      right: 12px;
      bottom: 14px;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(34,197,94,0.6);
      font-size: 11px;
      color: #bbf7d0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .metric {
      background: rgba(15,23,42,0.9);
      border-radius: 16px;
      border: 1px solid rgba(30,64,175,0.7);
      padding: 10px 10px 9px;
      font-size: 11px;
      color: var(--muted);
    }
    .metric-label {
      margin-bottom: 4px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .metric-value {
      font-size: 17px;
      font-weight: 600;
      color: #e5e7eb;
    }
    .metric-tag {
      font-size: 10px;
      margin-top: 1px;
    }
    .metric-tag.success { color: #bbf7d0; }
    .metric-tag.warn { color: #fed7aa; }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 10px 2px 6px;
      color: #cbd5f5;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .appt-card {
      border-radius: 16px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.7);
      padding: 10px 10px 9px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .appt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .appt-service {
      font-weight: 600;
      font-size: 13px;
    }
    .appt-status {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .08em;
      border: 1px solid;
    }
    .status-pending {
      border-color: rgba(234,179,8,0.7);
      background: rgba(250,204,21,0.08);
      color: #fde68a;
    }
    .status-confirmed {
      border-color: rgba(34,197,94,0.7);
      background: rgba(22,163,74,0.15);
      color: #bbf7d0;
    }
    .status-cancelled {
      border-color: rgba(248,113,113,0.75);
      background: rgba(190,24,93,0.12);
      color: #fecaca;
    }
    .appt-body {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .appt-info {
      font-size: 11px;
      color: var(--muted);
    }
    .appt-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .small-btn {
      font-size: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(239,68,68,0.12);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.6);
    }
    .small-btn:active {
      transform: translateY(1px);
    }
    .badge {
      font-size: 10px;
      color: #a5b4fc;
    }
    .empty-text {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 2px;
    }

    .profile-card {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 14px 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #38bdf8, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white;
      box-shadow: 0 12px 24px rgba(30,64,175,0.9);
    }
    .profile-info {
      flex: 1;
      min-width: 0;
    }
    .profile-name {
      font-size: 14px;
      font-weight: 600;
    }
    .profile-mail {
      font-size: 11px;
      color: var(--muted);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .profile-phone {
      font-size: 11px;
      color: #a5b4fc;
      margin-top: 2px;
    }
    .logout-btn {
      margin-top: 6px;
      width: 100%;
      padding: 9px 10px;
      border-radius: 999px;
      border: none;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(248,113,113,0.65);
      color: #fecaca;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }
    .logout-btn:active {
      transform: translateY(1px);
    }

    .info-row {
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .nav {
      position: fixed;
      bottom: 0;
      inset-inline: 0;
      padding: 6px 10px 10px;
      background: linear-gradient(to top, rgba(15,23,42,0.97), rgba(15,23,42,0.95));
      border-top: 1px solid rgba(30,64,175,0.7);
      box-shadow: 0 -10px 30px rgba(0,0,0,0.85);
      display: flex;
      gap: 10px;
      z-index: 20;
    }
    .nav-item {
      flex: 1;
      border-radius: 999px;
      padding: 6px 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      font-size: 10px;
      color: var(--muted);
      cursor: pointer;
      border: 1px solid transparent;
    }
    .nav-item span.icon {
      font-size: 16px;
    }
    .nav-item.active {
      background: rgba(37,99,235,0.15);
      border-color: rgba(59,130,246,0.9);
      color: #e5e7eb;
      box-shadow: 0 10px 24px rgba(37,99,235,0.7);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    #loadingText {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 2px;
    }

    #errorBox {
      font-size: 12px;
      color: #fecaca;
      margin-top: 4px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-badge">CR</div>
        <div class="brand-text">
          <span>Cepte Randevu</span>
          <span>m√º≈üteri paneli</span>
        </div>
      </div>
      <div class="user-pill" id="topUserName">Y√ºkleniyor...</div>
    </header>

    <main>
      <section id="section-home" class="section active">
        <div class="hero">
          <div class="hero-label">M√ú≈ûTERƒ∞ PANELƒ∞</div>
          <div class="hero-title" id="heroName">Merhaba</div>
          <div class="hero-sub" id="heroSub">
            Randevularƒ±n ve ge√ßmi≈ü i≈ülemlerin tek ekranda.
          </div>
          <div class="hero-row">
            <div class="hero-chip" id="heroNext">Yakla≈üan randevu bilgisi y√ºkleniyor...</div>
          </div>
          <div class="hero-badge">
            <span>‚ö° Ger√ßek zamanlƒ±</span>
          </div>
        </div>

        <div class="grid">
          <div class="metric">
            <div class="metric-label">Yakla≈üan</div>
            <div class="metric-value" id="metricUpcoming">0</div>
            <div class="metric-tag success">aktif randevu</div>
          </div>
          <div class="metric">
            <div class="metric-label">Ge√ßmi≈ü</div>
            <div class="metric-value" id="metricPast">0</div>
            <div class="metric-tag warn">tamamlanmƒ±≈ü</div>
          </div>
          <div class="metric">
            <div class="metric-label">ƒ∞ptal</div>
            <div class="metric-value" id="metricCancelled">0</div>
            <div class="metric-tag">iptal edilen</div>
          </div>
        </div>

        <div class="section-title">Son randevular</div>
        <div id="homeRecentList" class="card-list"></div>
        <div id="homeEmpty" class="empty-text" style="display:none;">
          Hen√ºz randevun yok. Bir i≈ületme sayfasƒ±ndan hƒ±zlƒ±ca randevu alabilirsin.
        </div>
      </section>

      <section id="section-appointments" class="section">
        <div class="pill">Randevularƒ±m</div>
        <div id="loadingText">Randevular y√ºkleniyor...</div>
        <div id="errorBox"></div>

        <div class="section-title">Yakla≈üan randevular</div>
        <div id="upcomingList" class="card-list"></div>
        <div id="upcomingEmpty" class="empty-text" style="display:none;">
          Yakla≈üan randevun bulunmuyor.
        </div>

        <div class="section-title">Ge√ßmi≈ü randevular</div>
        <div id="pastList" class="card-list"></div>
        <div id="pastEmpty" class="empty-text" style="display:none;">
          Ge√ßmi≈ü randevu kaydƒ±n hen√ºz bulunmuyor.
        </div>
      </section>

      <section id="section-profile" class="section">
        <div class="profile-card">
          <div class="avatar" id="avatarInitials">CR</div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">Kullanƒ±cƒ±</div>
            <div class="profile-mail" id="profileEmail">mail@ornek.com</div>
            <div class="profile-phone" id="profilePhone"></div>
          </div>
        </div>

        <div class="info-row">
          Bu panel √ºzerinden sadece randevularƒ±nƒ± g√∂r√ºnt√ºleyip iptal edebilirsin.
          ƒ∞≈ületme tarafƒ± i√ßin ayrƒ± y√∂netici paneli kullanƒ±lmalƒ±dƒ±r.
        </div>

        <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü yap</button>
      </section>
    </main>
  </div>

  <nav class="nav">
    <div class="nav-item active" data-target="home">
      <span class="icon">üè†</span>
      <span>Ana Sayfa</span>
    </div>
    <div class="nav-item" data-target="appointments">
      <span class="icon">üìÖ</span>
      <span>Randevular</span>
    </div>
    <div class="nav-item" data-target="profile">
      <span class="icon">üë§</span>
      <span>Profil</span>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      where,
      getDocs,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
      authDomain: "cepterandevu-35fe4.firebaseapp.com",
      projectId: "cepterandevu-35fe4",
      storageBucket: "cepterandevu-35fe4.appspot.com",
      messagingSenderId: "86298180836",
      appId: "1:86298180836:web:ab05fbb0dcfbb56b2700f1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const topUserName = document.getElementById("topUserName");
    const heroName = document.getElementById("heroName");
    const heroNext = document.getElementById("heroNext");

    const metricUpcoming = document.getElementById("metricUpcoming");
    const metricPast = document.getElementById("metricPast");
    const metricCancelled = document.getElementById("metricCancelled");

    const homeRecentList = document.getElementById("homeRecentList");
    const homeEmpty = document.getElementById("homeEmpty");

    const loadingText = document.getElementById("loadingText");
    const errorBox = document.getElementById("errorBox");

    const upcomingList = document.getElementById("upcomingList");
    const pastList = document.getElementById("pastList");
    const upcomingEmpty = document.getElementById("upcomingEmpty");
    const pastEmpty = document.getElementById("pastEmpty");

    const avatarInitials = document.getElementById("avatarInitials");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");
    const profilePhone = document.getElementById("profilePhone");
    const logoutBtn = document.getElementById("logoutBtn");

    const navItems = document.querySelectorAll(".nav-item");
    const sections = {
      home: document.getElementById("section-home"),
      appointments: document.getElementById("section-appointments"),
      profile: document.getElementById("section-profile"),
    };

    navItems.forEach(item => {
      item.addEventListener("click", () => {
        const target = item.getAttribute("data-target");
        for (const key in sections) {
          sections[key].classList.toggle("active", key === target);
        }
        navItems.forEach(n => n.classList.toggle("active", n === item));
      });
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/al/pages/user/user-login.html";
        return;
      }

      try {
        await loadUserProfile(user);
        startAppointmentsListener(user);
      } catch (err) {
        console.error(err);
        errorBox.textContent = "Veriler alƒ±nƒ±rken bir sorun olu≈ütu.";
      }
    });

    async function loadUserProfile(user) {
      profileEmail.textContent = user.email || "";
      const userDoc = await getDoc(doc(db, "users", user.uid));

      let name = "M√º≈üteri";
      let phone = "";

      if (userDoc.exists()) {
        const data = userDoc.data();
        if (data.fullName) name = data.fullName;
        if (data.phone) phone = data.phone;
      }

      profileName.textContent = name;
      profilePhone.textContent = phone ? "üìû " + phone : "";
      topUserName.textContent = name;
      heroName.textContent = `Merhaba, ${(name.split(" ")[0] || "misafir")}`;

      const initials = name.split(" ").map(p => p[0]).join("").substring(0,2).toUpperCase();
      avatarInitials.textContent = initials || "CR";
    }


    function startAppointmentsListener(user) {
      loadingText.style.display = "block";
      errorBox.textContent = "";
      homeRecentList.innerHTML = "";
      upcomingList.innerHTML = "";
      pastList.innerHTML = "";

      const qAppts = query(
        collection(db, "appointments"),
        where("customerId", "==", user.uid)
      );

      onSnapshot(qAppts, (snap) => {
        const now = new Date();
        const all = [];

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const dt = combineDateTime(data.date, data.time);
          all.push({ id, ...data, dt });
        });

        if (all.length === 0) {
          loadingText.style.display = "none";
          homeEmpty.style.display = "block";
          upcomingEmpty.style.display = "block";
          pastEmpty.style.display = "block";
          metricUpcoming.textContent = "0";
          metricPast.textContent = "0";
          metricCancelled.textContent = "0";
          heroNext.textContent = "Hen√ºz randevun yok.";
          homeRecentList.innerHTML = "";
          upcomingList.innerHTML = "";
          pastList.innerHTML = "";
          return;
        }

        all.sort((a, b) => b.dt - a.dt);

        const upcoming = [];
        const past = [];
        let cancelledCount = 0;

        for (const a of all) {
          if ((a.status || "").toLowerCase() === "cancelled") cancelledCount++;

          if (a.dt >= now && (a.status || "").toLowerCase() !== "cancelled") {
            upcoming.push(a);
          } else {
            past.push(a);
          }
        }

        metricUpcoming.textContent = upcoming.length;
        metricPast.textContent = past.length;
        metricCancelled.textContent = cancelledCount;

        if (upcoming.length > 0) {
          const nearest = [...upcoming].sort((a, b) => a.dt - b.dt)[0];
          heroNext.textContent = `${nearest.date || ""} ${nearest.time || ""} ‚Ä¢ ${nearest.serviceName || ""} (${nearest.workerName || "√áalƒ±≈üan"})`;
        } else {
          heroNext.textContent = "Yakla≈üan randevun yok.";
        }

        homeEmpty.style.display = "none";
        homeRecentList.innerHTML = "";
        all.slice(0,3).forEach(a => {
          const card = createAppointmentCard(a, { small: true, cancellable: false });
          homeRecentList.appendChild(card);
        });

        upcomingList.innerHTML = "";
        if (upcoming.length === 0) {
          upcomingEmpty.style.display = "block";
        } else {
          upcomingEmpty.style.display = "none";
          upcoming.forEach(a => {
            const card = createAppointmentCard(a, { small: false, cancellable: (a.status || "").toLowerCase() !== "cancelled" });
            upcomingList.appendChild(card);
          });
        }

        pastList.innerHTML = "";
        if (past.length === 0) {
          pastEmpty.style.display = "block";
        } else {
          pastEmpty.style.display = "none";
          past.forEach(a => {
            const card = createAppointmentCard(a, { small: false, cancellable: false });
            pastList.appendChild(card);
          });
        }

        loadingText.style.display = "none";
      }, (err) => {
        console.error(err);
        errorBox.textContent = "Veriler alƒ±nƒ±rken bir sorun olu≈ütu.";
        loadingText.style.display = "none";
      });
    }

    async function loadAppointments(user) {
      loadingText.style.display = "block";
      errorBox.textContent = "";
      homeRecentList.innerHTML = "";
      upcomingList.innerHTML = "";
      pastList.innerHTML = "";

      const qAppts = query(
        collection(db, "appointments"),
        where("customerId", "==", user.uid)
      );
      const snap = await getDocs(qAppts);

      const now = new Date();
      const all = [];

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const dt = combineDateTime(data.date, data.time);
        all.push({ id, ...data, dt });
      });

      if (all.length === 0) {
        loadingText.style.display = "none";
        homeEmpty.style.display = "block";
        upcomingEmpty.style.display = "block";
        pastEmpty.style.display = "block";
        metricUpcoming.textContent = "0";
        metricPast.textContent = "0";
        metricCancelled.textContent = "0";
        heroNext.textContent = "Hen√ºz randevun yok.";
        return;
      }

      all.sort((a, b) => b.dt - a.dt);

      const upcoming = [];
      const past = [];
      let cancelledCount = 0;

      for (const a of all) {
        if ((a.status || "").toLowerCase() === "cancelled") cancelledCount++;

        if (a.dt >= now && (a.status || "").toLowerCase() !== "cancelled") {
          upcoming.push(a);
        } else {
          past.push(a);
        }
      }

      metricUpcoming.textContent = upcoming.length;
      metricPast.textContent = past.length;
      metricCancelled.textContent = cancelledCount;

      if (upcoming.length > 0) {
        const nearest = [...upcoming].sort((a, b) => a.dt - b.dt)[0];
        heroNext.textContent = `${nearest.date || ""} ${nearest.time || ""} ‚Ä¢ ${nearest.serviceName || ""} (${nearest.workerName || "√áalƒ±≈üan"})`;
      } else {
        heroNext.textContent = "Yakla≈üan randevun yok.";
      }

      homeEmpty.style.display = "none";
      all.slice(0,3).forEach(a => {
        const card = createAppointmentCard(a, { small: true, cancellable: false });
        homeRecentList.appendChild(card);
      });

      if (upcoming.length === 0) {
        upcomingEmpty.style.display = "block";
      } else {
        upcomingEmpty.style.display = "none";
        upcoming.forEach(a => {
          const card = createAppointmentCard(a, { small: false, cancellable: (a.status || "").toLowerCase() !== "cancelled" });
          upcomingList.appendChild(card);
        });
      }

      if (past.length === 0) {
        pastEmpty.style.display = "block";
      } else {
        pastEmpty.style.display = "none";
        past.forEach(a => {
          const card = createAppointmentCard(a, { small: false, cancellable: false });
          pastList.appendChild(card);
        });
      }

      loadingText.style.display = "none";
    }

    function combineDateTime(dateStr, timeStr) {
      try {
        if (!dateStr || !timeStr) return new Date(0);
        return new Date(`${dateStr}T${timeStr}:00`);
      } catch {
        return new Date(0);
      }
    }

    function createAppointmentCard(a, { small, cancellable }) {
      const card = document.createElement("div");
      card.className = "appt-card";

      const header = document.createElement("div");
      header.className = "appt-header";

      const service = document.createElement("div");
      service.className = "appt-service";
      service.textContent = a.serviceName || "Hizmet";

      const status = document.createElement("div");
      status.className = "appt-status";

      const st = (a.status || "pending").toLowerCase();
      if (st === "confirmed") {
        status.classList.add("status-confirmed");
        status.textContent = "ONAYLANDI";
      } else if (st === "cancelled") {
        status.classList.add("status-cancelled");
        status.textContent = "ƒ∞PTAL EDƒ∞LDƒ∞";
      } else {
        status.classList.add("status-pending");
        status.textContent = "BEKLEMEDE";
      }

      header.appendChild(service);
      header.appendChild(status);

      const body = document.createElement("div");
      body.className = "appt-body";

      const info = document.createElement("div");
      info.className = "appt-info";
      info.innerHTML = `
        <div>${a.date || ""} ‚Ä¢ ${a.time || ""}</div>
        <div>${a.workerName || "√áalƒ±≈üan"} ‚Ä¢ ${a.businessName || ""}</div>
      `;

      const actions = document.createElement("div");
      actions.className = "appt-actions";

      if (!small) {
        const whenText = document.createElement("div");
        whenText.className = "badge";
        whenText.textContent = friendlyDiffText(a.dt);
        actions.appendChild(whenText);
      }

      if (cancellable && st !== "cancelled") {
        const btn = document.createElement("button");
        btn.className = "small-btn";
        btn.textContent = "Randevuyu iptal et";
        btn.addEventListener("click", () => handleCancel(a.id, card));
        actions.appendChild(btn);
      }

      body.appendChild(info);
      body.appendChild(actions);

      card.appendChild(header);
      card.appendChild(body);

      return card;
    }

    function friendlyDiffText(date) {
      const now = new Date();
      const diffMs = date - now;
      const diffMin = Math.round(diffMs / 60000);

      if (diffMin <= -60) {
        const h = Math.abs(Math.round(diffMin / 60));
        return `${h} saat √∂nceydi`;
      }
      if (diffMin < 0) {
        return "Az √∂nceydi";
      }
      if (diffMin < 60) {
        return `${diffMin} dk sonra`;
      }
      const h = Math.round(diffMin / 60);
      if (h < 24) {
        return `${h} saat sonra`;
      }
      const d = Math.round(h / 24);
      return `${d} g√ºn sonra`;
    }

    async function handleCancel(id, cardEl) {
      if (!confirm("Bu randevuyu iptal etmek istiyor musunuz?")) return;
      try {
        await updateDoc(doc(db, "appointments", id), {
          status: "cancelled"
        });
        const statusEl = cardEl.querySelector(".appt-status");
        statusEl.className = "appt-status status-cancelled";
        statusEl.textContent = "ƒ∞PTAL EDƒ∞LDƒ∞";
      } catch (err) {
        console.error(err);
        alert("ƒ∞ptal i≈ülemi sƒ±rasƒ±nda hata olu≈ütu.");
      }
    }

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "/al/pages/user/user-login.html";
      } catch (err) {
        console.error(err);
        alert("√áƒ±kƒ±≈ü yapƒ±lƒ±rken hata olu≈ütu.");
      }
    });
  </script>
</body>
</html>
