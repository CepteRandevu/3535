<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yorum Yap</title>
  <link rel="stylesheet" href="../styles/global.css" />

  <style>
    body {
      margin: 0;
      background: #f6f7fb;
      font-family: Arial, sans-serif;
    }

    .card {
      background: white;
      margin: 16px;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border-radius: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      resize: none;
    }

    .stars {
      font-size: 28px;
      text-align: center;
      margin-top: 10px;
      cursor: pointer;
      user-select: none;
    }

    .btn {
      width: calc(100% - 32px);
      margin: 20px 16px;
      padding: 14px;
      border-radius: 12px;
      background: linear-gradient(90deg, #ff7a45, #0099ff);
      color: white;
      border: none;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>

</head>
<body>

  <!-- PREMIUM BAR -->
  <div class="randeo-bar">
    <button onclick="history.back()">‚Üê</button>
    <div class="title">Yorum Yap</div>
    <div class="randeo-profile-btn" onclick="goProfile()">üë§</div>
  </div>

  <div class="card">
    <div class="stars" id="starBox">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
  </div>

  <div class="card">
    <textarea id="commentInput" placeholder="Yorumunuzu yazƒ±n..."></textarea>
  </div>

  <button class="btn" id="sendBtn">G√∂nder</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore, collection, addDoc,
      doc, getDoc, updateDoc, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
      authDomain: "cepterandevu-35fe4.firebaseapp.com",
      projectId: "cepterandevu-35fe4",
      storageBucket: "cepterandevu-35fe4.firebasestorage.app",
      messagingSenderId: "86298180836",
      appId: "1:86298180836:web:ab05fbb0dcfbb56b2700f1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const url = new URL(window.location.href);
    const businessId = url.searchParams.get("id");

    let currentUser = null;
    let selectedRating = 0;

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Yorum yazmak i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.");
        window.location.href = "../login.html";
      } else {
        currentUser = user;
      }
    });

    /* ------------------------------
        YILDIZ SE√áƒ∞Mƒ∞
    ------------------------------*/
    const starBox = document.getElementById("starBox");

    function updateStars(n) {
      selectedRating = n;
      let output = "";
      for (let i = 1; i <= 5; i++) {
        output += i <= n ? "‚≠ê" : "‚òÜ";
      }
      starBox.textContent = output;
    }

    starBox.addEventListener("click", (e) => {
      const rect = starBox.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const w = rect.width;

      const index = Math.ceil((x / w) * 5);
      updateStars(index);
    });

    /* ------------------------------
          G√ñNDER
    ------------------------------*/
    document.getElementById("sendBtn").onclick = async () => {
      if (selectedRating === 0) {
        alert("L√ºtfen yƒ±ldƒ±z verin.");
        return;
      }

      const comment = document.getElementById("commentInput").value.trim();
      if (!comment) {
        alert("L√ºtfen yorum yazƒ±n.");
        return;
      }

      await addDoc(collection(db, "reviews"), {
        businessId,
        customerId: currentUser.uid,
        rating: selectedRating,
        comment: comment,
        createdAt: new Date()
      });

      // PUAN ORTALAMASI G√úNCELLE
      const ref = doc(db, "businesses", businessId);
      const snap = await getDoc(ref);

      if (snap.exists()) {
        const data = snap.data();
        const oldAvg = data.ratingAvg || 0;
        const oldCount = data.ratingCount || 0;

        const newAvg =
          (oldAvg * oldCount + selectedRating) / (oldCount + 1);

        await updateDoc(ref, {
          ratingAvg: newAvg,
          ratingCount: increment(1)
        });
      }

      alert("Yorumunuz kaydedildi!");
      window.location.href = `detail.html?id=${businessId}`;
    };
  </script>

  <script>
    function goProfile() {
      window.location.href = "../pages/customer-profile.html";
    }
  </script>

</body>
</html>
