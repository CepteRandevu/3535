<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Randevular | Cepterandevu</title>

  <!-- PWA + FCM için manifest -->
  <link rel="manifest" href="/manifest.json">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050816;
      --sidebar: #0b1120;
      --card: #101528;
      --accent: #22c55e;
      --accent-strong: #16a34a;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: rgba(148,163,184,0.35);
      --radius-xl: 18px;
      --shadow-soft: 0 10px 30px rgba(10, 10, 20, 0.75);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #111827, #020617 55%);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
    }

    .top-header {
      width: 100%;
      padding-top: 14px;
      padding-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 500;
      background: var(--sidebar);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .top-center {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      width: 100%;
    }

    .top-menu-row {
      width: 100%;
      display: flex;
      justify-content: flex-start;
      padding-left: 20px;
      padding-bottom: 14px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 10%, #4ade80, #16a34a 42%, #0f766e);
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 800;
      font-size: 18px;
      color: #ecfdf5;
      box-shadow: 0 6px 20px rgba(34,197,94,0.4);
    }

    .logo-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
    }

    .menu-btn {
      background: var(--accent);
      color: #022c22;
      border: 0;
      padding: 9px 15px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(34 197 94 0.35);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .menu-btn i { font-size: 14px; }

    .sidebar {
      width: 240px;
      background: var(--sidebar);
      padding: 24px 18px;
      border-right: 1px solid var(--border);
      position: fixed;
      top: 0; bottom: 0;
      display: none;
      flex-direction: column;
      gap: 14px;
      z-index: 1000;
    }

    .logo-box {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      justify-content: flex-start;
    }

    .biz-name-small {
      font-size: 16px;
      font-weight: 700;
    }

    .menu button {
      width: 100%;
      padding: 12px 14px;
      background: transparent;
      border: 0;
      text-align: left;
      color: var(--muted);
      cursor: pointer;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu button:hover {
      background: rgba(34, 197, 94, 0.1);
      color: var(--text);
    }

    .menu button.active {
      background: var(--accent);
      color: #022c22;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(34,197,94,0.3);
    }

    .main-area {
      flex: 1;
      padding: 20px;
      width: 100%;
      min-height: 100vh;
      padding-top: 110px;
    }

    .title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text);
      display: none;
    }

    .card {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .card-header span {
      font-size: 12px;
      color: var(--muted);
    }

    .appt-row {
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      transition: background 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .appt-row.new-pending {
      animation: pulseRow 1.2s ease-in-out infinite;
      border-color: rgba(34,197,94,0.9);
    }

    @keyframes pulseRow {
      0% {
        background: rgba(34,197,94,0.10);
        box-shadow: 0 0 0 0 rgba(34,197,94,0.55);
      }
      50% {
        background: rgba(34,197,94,0.22);
        box-shadow: 0 0 0 8px rgba(34,197,94,0.05);
      }
      100% {
        background: rgba(34,197,94,0.10);
        box-shadow: 0 0 0 0 rgba(34,197,94,0.0);
      }
    }

    .appt-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .appt-main-line {
      font-weight: 600;
      font-size: 14px;
    }

    .appt-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .appt-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: capitalize;
    }
    .pending  { background: rgba(234,179,8,0.18); color:#facc15; }
    .approved { background: rgba(34,197,94,0.22); color:#4ade80; }
    .rejected { background: rgba(239,68,68,0.22); color:#fca5a5; }
    .cancelled { background: rgba(148,163,184,0.22); color:#e5e7eb; }

    .tag {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 11px;
      color: var(--muted);
    }

    .btn-sm {
      padding: 6px 10px;
      border-radius: 9px;
      border: 0;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-approve {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #022c22;
      box-shadow: 0 8px 20px rgba(34,197,94,0.4);
    }

    .btn-reject {
      background: #ef4444;
      color: white;
    }

    .btn-sm:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .empty {
      font-size: 13px;
      color: var(--muted);
      padding: 10px 2px;
    }

    @media (max-width: 720px) {
      .appt-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .appt-right {
        align-items: flex-start;
      }
    }

    .drawer-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(2px);
      display: none;
      z-index: 998;
    }

    .drawer-menu {
      position: fixed;
      top: 0; left: 0;
      width: 250px;
      height: 100%;
      background: #0b1120;
      transform: translateX(-100%);
      transition: transform 0.28s ease;
      z-index: 9999;
      padding: 20px;
      border-right: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }

    .drawer-open { transform: translateX(0); }

    .drawer-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 18px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .drawer-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .drawer-links a {
      display: block;
      padding: 12px 10px;
      color: #e2e8f0;
      font-size: 15px;
      text-decoration: none;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
    }

    .drawer-links a:hover,
    .drawer-links a.active {
      background: var(--accent);
      color: #022c22;
      font-weight: 600;
    }

    @media (min-width: 768px) {
      body { flex-direction: row; }
      .sidebar { display: flex; }
      .top-header { display: none; }
      .main-area {
        margin-left: 240px;
        padding: 32px;
        padding-top: 32px;
      }
      .title { display: block; }
    }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>
<body>
  <!-- Drawer -->
  <div id="drawerOverlay" class="drawer-overlay"></div>
  <div id="drawerMenu" class="drawer-menu">
    <div class="drawer-title">Cepterandevu</div>
    <div class="drawer-links">
      <a href="business-panel.html">Panel</a>
      <a href="business-services.html">Hizmetler</a>
      <a href="business-employees.html">Çalışanlar</a>
      <a href="business-appointments.html" class="active">Randevular</a>
      <a href="business-settings.html">Ayarlar</a>
    </div>
  </div>

  <!-- Üst Header -->
  <header class="top-header">
    <div class="top-center">
      <div class="logo-mark">C</div>
      <span class="logo-title" id="bizNameMobile">Randevular</span>
    </div>
    <div class="top-menu-row">
      <button id="menuBtn" class="menu-btn">
        <i class="fas fa-bars"></i> Menü
      </button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo-box">
      <div class="logo-mark">C</div>
      <div class="biz-name-small" id="bizNameSmallSidebar">İşletme</div>
    </div>

    <div class="menu">
      <button onclick="location.href='business-panel.html'"><i class="fas fa-tachometer-alt"></i> Panel</button>
      <button onclick="location.href='business-services.html'"><i class="fas fa-wrench"></i> Hizmetler</button>
      <button onclick="location.href='business-employees.html'"><i class="fas fa-users"></i> Çalışanlar</button>
      <button class="active" onclick="location.href='business-appointments.html'"><i class="fas fa-calendar-alt"></i> Randevular</button>
      <button onclick="location.href='business-settings.html'"><i class="fas fa-cog"></i> Ayarlar</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-area">
    <h1 class="title" id="bizTitle">Randevu Yönetimi</h1>

    <div class="card">
      <div class="card-header">
        <h3>Bekleyen Randevular</h3>
        <span id="pendingCount">0 adet</span>
      </div>
      <div id="pendingList">
        <div class="empty">Şu anda bekleyen randevu yok.</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Tüm Randevular</h3>
        <span id="allCount">0 adet</span>
      </div>
      <div id="allList">
        <div class="empty">Henüz randevu oluşturulmamış.</div>
      </div>
    </div>
  </main>

  <!-- Drawer JS -->
  <script>
    const drawer = document.getElementById("drawerMenu");
    const overlay = document.getElementById("drawerOverlay");
    const menuBtn = document.getElementById("menuBtn");

    function openDrawer() {
      drawer.classList.add("drawer-open");
      overlay.style.display = "block";
    }
    function closeDrawer() {
      drawer.classList.remove("drawer-open");
      overlay.style.display = "none";
    }

    menuBtn.addEventListener("click", openDrawer);
    overlay.addEventListener("click", closeDrawer);
  </script>

  <!-- Firebase + Randevular + Push (TEK MODULE) -->
  <script type="module">
    import { firebaseConfig } from "../js/firebase-config.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      doc,
      getDoc,
      updateDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getMessaging,
      getToken,
      onMessage
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

    // UYGULAMA TEK KEZ BAŞLATILIYOR
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    // Service worker kaydı
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then(reg => {
          console.log("Service worker kayıtlı:", reg);
        })
        .catch(err => {
          console.error("Service worker kaydı hatası:", err);
        });
    }

    let businessID = null;

    const bizNameSmallSidebar = document.getElementById("bizNameSmallSidebar");
    const bizNameMobile = document.getElementById("bizNameMobile");
    const bizTitle = document.getElementById("bizTitle");

    const pendingListEl = document.getElementById("pendingList");
    const allListEl = document.getElementById("allList");
    const pendingCountEl = document.getElementById("pendingCount");
    const allCountEl = document.getElementById("allCount");

    const userCache = {};
    const serviceCache = {};
    const employeeCache = {};

    const NEW_PENDING_WINDOW_MS = 20000;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "business-login.html";
        return;
      }

      businessID = user.uid;
      await loadBusinessName();

      // Kullanıcı giriş yapmışken push izni iste + token kaydet
      await setupPushForUser(user);

      // Randevuları dinlemeye başla
      listenAppointmentsRealtime();
    });

    async function loadBusinessName() {
      try {
        const ref = doc(db, "businesses", businessID);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const name = snap.data().name || "İşletme";
          bizNameSmallSidebar.textContent = name;
          bizNameMobile.textContent = "Randevular · " + name;
          bizTitle.textContent = name + " · Randevular";
        }
      } catch (e) {
        console.error("İşletme ismi okunamadı:", e);
      }
    }

    function sortAppointments(list) {
      return list.slice().sort((a, b) => {
        if (a.date === b.date) {
          return (a.time || "").localeCompare(b.time || "");
        }
        return (a.date || "").localeCompare(b.date || "");
      });
    }

    async function enrichAppointments(items) {
      const result = [];

      for (const ap of items) {
        const obj = { ...ap };

        if (ap.customerUID) {
          if (!userCache[ap.customerUID]) {
            try {
              let usnap = await getDoc(doc(db, "customers", ap.customerUID));
              if (!usnap.exists()) {
                usnap = await getDoc(doc(db, "users", ap.customerUID));
              }
              userCache[ap.customerUID] = usnap.exists() ? usnap.data() : null;
            } catch (e) {
              console.error("Kullanıcı okunamadı:", e);
            }
          }
          const u = userCache[ap.customerUID];
          if (u) {
            obj.customerName = u.name || u.fullName || "";
            obj.customerPhone = u.phone || u.tel || "";
          }
        }

        if (ap.serviceID) {
          if (!serviceCache[ap.serviceID]) {
            try {
              const ssnap = await getDoc(doc(db, "services", ap.serviceID));
              serviceCache[ap.serviceID] = ssnap.exists() ? ssnap.data() : null;
            } catch(e) {
              console.error("Hizmet okunamadı:", e);
            }
          }
          const s = serviceCache[ap.serviceID];
          if (s) {
            obj.serviceName = s.name || "";
            obj.serviceDuration = s.duration || null;
          }
        }

        if (ap.employeeID) {
          if (!employeeCache[ap.employeeID]) {
            try {
              const esnap = await getDoc(doc(db, "employees", ap.employeeID));
              employeeCache[ap.employeeID] = esnap.exists() ? esnap.data() : null;
            } catch(e) {
              console.error("Çalışan okunamadı:", e);
            }
          }
          const emp = employeeCache[ap.employeeID];
          if (emp) {
            obj.employeeName = emp.name || "";
          }
        }

        result.push(obj);
      }

      return result;
    }

    function renderAppointments(items) {
      const pending = items.filter(ap => ap.status === "pending");
      const sortedAll = sortAppointments(items);
      const sortedPending = sortAppointments(pending);

      pendingListEl.innerHTML = "";
      allListEl.innerHTML = "";

      pendingCountEl.textContent = `${pending.length} adet`;
      allCountEl.textContent = `${items.length} adet`;

      if (sortedPending.length === 0) {
        pendingListEl.innerHTML = `<div class="empty">Şu anda bekleyen randevu yok.</div>`;
      } else {
        sortedPending.forEach(ap => {
          pendingListEl.appendChild(buildAppointmentRow(ap, true));
        });
      }

      if (sortedAll.length === 0) {
        allListEl.innerHTML = `<div class="empty">Henüz randevu oluşturulmamış.</div>`;
      } else {
        sortedAll.forEach(ap => {
          allListEl.appendChild(buildAppointmentRow(ap, false));
        });
      }
    }

    function buildAppointmentRow(ap, isPendingSection) {
      const row = document.createElement("div");
      row.className = "appt-row";

      const now = Date.now();
      if (ap.status === "pending" && ap.createdAt && (now - ap.createdAt) <= NEW_PENDING_WINDOW_MS) {
        row.classList.add("new-pending");
      }

      const left = document.createElement("div");
      left.className = "appt-left";

      const mainLine = document.createElement("div");
      mainLine.className = "appt-main-line";

      const svcText = ap.serviceName ? ap.serviceName : ap.serviceID || "Hizmet";
      const empText = ap.employeeName ? ap.employeeName : ap.employeeID || "";

      mainLine.textContent = `${svcText} · ${ap.date || "-"} ${ap.time || ""}`;

      const sub1 = document.createElement("div");
      sub1.className = "appt-sub";
      sub1.textContent = empText ? `Çalışan: ${empText}` : "";

      const sub2 = document.createElement("div");
      sub2.className = "appt-sub";
      const cName = ap.customerName || "Müşteri";
      const cPhone = ap.customerPhone || "";
      sub2.textContent = cPhone ? `${cName} · ${cPhone}` : cName;

      left.appendChild(mainLine);
      if (sub1.textContent) left.appendChild(sub1);
      left.appendChild(sub2);

      const right = document.createElement("div");
      right.className = "appt-right";

      const statusEl = document.createElement("span");
      statusEl.className = `status ${ap.status || "pending"}`;
      statusEl.textContent =
        ap.status === "pending"   ? "Beklemede" :
        ap.status === "approved"  ? "Onaylandı" :
        ap.status === "rejected"  ? "Reddedildi" :
        ap.status === "cancelled" ? "İptal" : (ap.status || "Durum");

      right.appendChild(statusEl);

      const tag = document.createElement("span");
      tag.className = "tag";
      const createdText = ap.createdAt
        ? new Date(ap.createdAt).toLocaleString("tr-TR")
        : "-";
      tag.textContent = `Oluşturma: ${createdText}`;
      right.appendChild(tag);

      if (ap.status === "pending") {
        const btnRow = document.createElement("div");
        btnRow.style.display = "flex";
        btnRow.style.gap = "6px";

        const approveBtn = document.createElement("button");
        approveBtn.className = "btn-sm btn-approve";
        approveBtn.textContent = "Onayla";
        approveBtn.onclick = () => updateStatus(ap.id, "approved", approveBtn);

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "btn-sm btn-reject";
        rejectBtn.textContent = "Reddet";
        rejectBtn.onclick = () => updateStatus(ap.id, "rejected", rejectBtn);

        btnRow.appendChild(approveBtn);
        btnRow.appendChild(rejectBtn);
        right.appendChild(btnRow);
      }

      row.appendChild(left);
      row.appendChild(right);

      return row;
    }

    async function updateStatus(id, newStatus, btn) {
      try {
        if (btn) btn.disabled = true;
        const ref = doc(db, "appointments", id);
        await updateDoc(ref, { status: newStatus, updatedAt: Date.now() });
      } catch (e) {
        console.error("Durum güncellenemedi:", e);
        alert("Durum güncellenirken hata oluştu.");
        if (btn) btn.disabled = false;
      }
    }

    function listenAppointmentsRealtime() {
      const qRef = query(
        collection(db, "appointments"),
        where("businessID", "==", businessID)
      );

      onSnapshot(qRef, async (snap) => {
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        const enriched = await enrichAppointments(items);
        renderAppointments(enriched);
      }, (err) => {
        console.error("Randevu dinleme hatası:", err);
      });
    }

    // PUSH KURULUMU
    async function setupPushForUser(user) {
      try {
        if (!("Notification" in window)) {
          console.log("Tarayıcı bildirim desteklemiyor.");
          return;
        }

        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          console.log("Bildirim izni verilmedi:", permission);
          return;
        }

        const registration = await navigator.serviceWorker.ready;

        const currentToken = await getToken(messaging, {
          vapidKey: "BHz_LvVX9Y9cQxHWZOYLX-YscxL6gItx9sQetA8uJurvn8aAXA3t9K2TYwvr2_xG3jg19P5y2aXLhENWbCBx_Pc",
          serviceWorkerRegistration: registration,
        });

        if (!currentToken) {
          console.log("FCM token alınamadı");
          return;
        }

        console.log("FCM token:", currentToken);

        await setDoc(
          doc(db, "userPushTokens", user.uid),
          {
            token: currentToken,
            updatedAt: Date.now(),
            phone: user.phoneNumber || null,
            type: "business"
          },
          { merge: true }
        );

        console.log("Token Firestore'a kaydedildi.");
      } catch (err) {
        console.error("Push kurulurken hata:", err);
      }
    }

    // Site açıkken gelen bildirimler
    onMessage(messaging, (payload) => {
      console.log("Ön planda bildirim:", payload);
      // İstersen buraya toast / mini popup ekleyebilirsin
    });
  </script>
</body>
</html>
