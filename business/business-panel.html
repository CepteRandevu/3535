<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>İşletme Paneli | Cepterandevu</title>

<style>
:root {
  --bg:#050816;
  --sidebar:#0b1120;
  --card:#101528;
  --accent:#22c55e;
  --accent-strong:#16a34a;
  --text:#f9fafb;
  --muted:#9ca3af;
  --border:rgba(148,163,184,0.35);
  --radius-xl:20px;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  background:radial-gradient(circle at top,#111827,#020617 55%);
  color:var(--text);
  font-family:system-ui;
  display:flex;
  min-height:100vh;
}

/* Mobil üst menü */
.top-header{
  background:#0b1120;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:900;
  border-bottom:1px solid var(--border);
}
.logo-mark{
  background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
  width:34px;height:34px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;color:#ecfdf5;
}
.logo-title{
  font-size:16px;font-weight:600;margin-left:8px;
}

/* Sidebar */
.sidebar{
  width:240px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  padding:20px;
  flex-shrink:0;
  display:none;
}
.sidebar .menu-btn{
  display:block;
  background:transparent;
  border:0;
  padding:12px;
  width:100%;
  text-align:left;
  border-radius:12px;
  color:var(--muted);
  cursor:pointer;
}
.sidebar .menu-btn:hover{
  background:rgba(34,197,94,0.12);
  color:var(--text);
}
.sidebar .menu-btn.active{
  background:var(--accent);
  color:#022c22;
  font-weight:600;
}

@media(min-width:900px){
  .sidebar{display:block;}
  .top-header{display:none;}
}

/* MAIN */
.main{
  flex:1;
  padding:20px;
}
.page-title{
  font-size:22px;
  font-weight:700;
  margin-bottom:18px;
}

/* Randevu Kartı */
.appt-card{
  background:var(--card);
  padding:16px;
  border-radius:var(--radius-xl);
  border:1px solid var(--border);
  margin-bottom:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.appt-header{
  display:flex;
  justify-content:space-between;
  font-size:15px;
  font-weight:600;
}
.appt-sub{
  font-size:13px;color:var(--muted);
}
.appt-status{
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
}
.status-pending{
  background:rgba(234,179,8,0.2);
  color:#facc15;
}
.status-approved{
  background:rgba(34,197,94,0.2);
  color:#4ade80;
}
.status-rejected{
  background:rgba(248,113,113,0.2);
  color:#f87171;
}

</style>
</head>

<body>

<!-- Mobil üst menü -->
<header class="top-header">
  <div style="display:flex;align-items:center;">
    <div class="logo-mark">C</div>
    <span class="logo-title" id="bizNameMobile">Panel</span>
  </div>
</header>

<!-- Sidebar -->
<aside class="sidebar">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
    <div class="logo-mark">C</div>
    <div id="bizNameSmall" style="font-size:15px;font-weight:600;">İşletme</div>
  </div>
  <button class="menu-btn active">Panel</button>
  <button class="menu-btn" onclick="location.href='business-services.html'">Hizmetler</button>
  <button class="menu-btn" onclick="location.href='business-employees.html'">Çalışanlar</button>
  <button class="menu-btn" onclick="location.href='business-appointments.html'">Randevular</button>
  <button class="menu-btn" onclick="location.href='business-agenda.html'">Ajanda</button>
 <button class="menu-btn" onclick="location.href='business-settings.html'">Ayarlar</button>
</aside>

<main class="main">
  <h1 class="page-title">En Son Randevular</h1>

  <div id="appointments"></div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
  authDomain: "cepterandevu-35fe4.firebaseapp.com",
  projectId: "cepterandevu-35fe4",
  storageBucket: "cepterandevu-35fe4.firebasestorage.app",
  messagingSenderId: "86298180836",
  appId: "1:86298180836:web:124c2004605d68b32700f1",
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/* ---------------- DOM ---------------- */
const bizNameSmall  = document.getElementById("bizNameSmall");
const bizNameMobile = document.getElementById("bizNameMobile");
const appointmentsEl = document.getElementById("appointments");

let BUSINESS_ID = null;

/* ---------------- AUTH ---------------- */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "business-login.html";
    return;
  }

  BUSINESS_ID = user.uid;

  await loadBusinessInfo();
  await loadAppointments();
});

/* ---------------- BUSINESS INFO ---------------- */
async function loadBusinessInfo(){
  const ref = doc(db,"businesses",BUSINESS_ID);
  const snap = await getDoc(ref);

  if(snap.exists()){
    const d = snap.data();
    bizNameSmall.textContent  = d.name || "İşletme";
    bizNameMobile.textContent = d.name || "Panel";
  }
}
/* ---------------- LOAD APPOINTMENTS ---------------- */
async function loadAppointments(){
  appointmentsEl.innerHTML = "Yükleniyor...";

  const qRef = query(
    collection(db,"appointments"),
    where("businessID","==",BUSINESS_ID)
  );

  const snap = await getDocs(qRef);

  let list = [];

  snap.forEach(s=>{
    const d = s.data();
    list.push({
      id: s.id,
      customerUID: d.customerUID,
      serviceID: d.serviceID,
      employeeID: d.employeeID,
      date: d.date,
      time: d.time,
      status: d.status || "pending",
      createdAt: d.createdAt || 0
    });
  });

  /* --- En yeni randevu en üstte --- */
  list.sort((a,b)=> b.createdAt - a.createdAt);

  if(list.length === 0){
    appointmentsEl.innerHTML = "<div style='color:#94a3b8;font-size:14px;'>Henüz randevu yok.</div>";
    return;
  }

  appointmentsEl.innerHTML = "";

  for (const appt of list){
    const customer = await loadCustomer(appt.customerUID);
    const service  = await loadService(appt.serviceID);
    const employee = await loadEmployee(appt.employeeID);

    const statusClass = {
      pending: "status-pending",
      approved: "status-approved",
      rejected: "status-rejected"
    }[appt.status] || "status-pending";

    const card = document.createElement("div");
    card.className = "appt-card";

    card.innerHTML = `
      <div class="appt-header">
        <div>${customer?.name || "Müşteri"}</div>
        <div class="appt-status ${statusClass}">
          ${appt.status === "pending" ? "Beklemede" :
            appt.status === "approved" ? "Onaylandı" : "Reddedildi"}
        </div>
      </div>

      <div class="appt-sub">
        ${service?.name || "Hizmet"} · ${employee?.name || "Çalışan"}
      </div>

      <div class="appt-sub">
        ${formatDate(appt.date)} ${appt.time}
      </div>
    `;

    appointmentsEl.appendChild(card);
  }
}

/* ---------------- HELPERS ---------------- */
async function loadCustomer(uid){
  if(!uid) return null;
  const ref = doc(db,"users",uid);
  const snap= await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}

async function loadService(id){
  if(!id) return null;
  const ref = doc(db,"services",id);
  const snap= await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}

async function loadEmployee(id){
  if(!id) return null;
  const ref = doc(db,"employees",id);
  const snap= await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}

function formatDate(d){
  const parts = d.split("-");
  return `${parts[2]}.${parts[1]}.${parts[0]}`;
}

</script>

</main>
</body>
</html>
