<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ayarlar | Cepterandevu</title>

  <style>
    :root {
      --bg:#050816;
      --sidebar:#0b1120;
      --card:#101528;
      --accent:#22c55e;
      --accent-strong:#16a34a;
      --text:#f9fafb;
      --muted:#9ca3af;
      --border:rgba(148,163,184,0.35);
      --shadow-soft:0 18px 45px rgba(15,23,42,0.85);
      --radius-xl:18px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      background:radial-gradient(circle at top,#111827,#020617 55%);
      font-family:system-ui,sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* LOGO ALANI */
    .logo-box2{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:14px;
    }

    .logo-preview{
      width:120px;
      height:120px;
      border-radius:16px;
      object-fit:cover;
      background:#020617;
      border:1px solid var(--border);
    }

    .upload-btn{
      padding:9px 14px;
      background:var(--accent);
      color:#022c22;
      border:none;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      font-size:14px;
    }

    .drawer-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.55);
      backdrop-filter:blur(2px);
      display:none;z-index:998;
    }

    .drawer-menu{
      position:fixed;top:0;left:0;width:250px;height:100%;
      background:#0b1120;
      transform:translateX(-100%);
      transition:.28s;
      z-index:999;
      padding:20px;
      border-right:1px solid rgba(255,255,255,0.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .drawer-open{transform:translateX(0);}
    .drawer-title{font-size:20px;font-weight:700;margin-bottom:10px;color:var(--accent);}

    .drawer-links a{
      display:block;text-decoration:none;color:#e2e8f0;
      padding:10px 12px;border-radius:10px;font-size:14px;
    }
    .drawer-links a:hover,
    .drawer-links a.active{
      background:var(--accent);color:#022c22;font-weight:600;
    }

    .top-header{
      background:#0b1120;border-bottom:1px solid var(--border);
      padding:10px 0 10px;position:sticky;top:0;z-index:900;
      display:flex;flex-direction:column;gap:6px;
    }

    .top-center{display:flex;justify-content:center;align-items:center;gap:10px;}
    .logo-mark{
      width:34px;height:34px;border-radius:14px;
      background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;color:#ecfdf5;
      cursor:pointer;
    }
    .logo-title{font-size:16px;font-weight:600;}
    .top-menu-row{padding-left:16px;}
    .menu-btn{
      background:var(--accent);border:0;color:#022c22;
      padding:7px 14px;border-radius:10px;font-weight:600;
      cursor:pointer;font-size:14px;
    }

    .sidebar{
      width:240px;background:var(--sidebar);padding:24px 18px;
      border-right:1px solid var(--border);position:fixed;top:0;bottom:0;
      display:none;flex-direction:column;gap:14px;z-index:800;
    }

    .logo-box{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
    .biz-name-small{font-size:15px;font-weight:600;}

    .menu button{
      width:100%;padding:10px 12px;background:transparent;border:0;
      text-align:left;color:var(--muted);cursor:pointer;border-radius:12px;
      font-size:14px;display:flex;align-items:center;gap:8px;
    }

    .menu button:hover{
      background:rgba(34,197,94,0.12);color:var(--text);
    }

    .menu button.active{
      background:var(--accent);color:#022c22;font-weight:600;
    }

    .main-area{padding:20px 18px 28px;}
    .page-title{font-size:20px;font-weight:700;margin-bottom:16px;}

    .card{
      background:var(--card);border-radius:var(--radius-xl);
      border:1px solid var(--border);padding:18px 16px 20px;
      margin-bottom:18px;box-shadow:var(--shadow-soft);
    }

    .card h3{font-size:16px;margin-bottom:10px;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:5px;}

    input, select, textarea{
      width:100%;padding:9px 11px;border-radius:12px;background:#020617;
      border:1px solid var(--border);color:var(--text);margin-bottom:10px;
      font-size:13px;outline:none;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);box-shadow:0 0 0 1px var(--accent);
    }

    .row-two{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-bottom:10px;
    }

    .schedule-info{
      font-size:12px;color:var(--muted);margin-bottom:8px;
    }

    .schedule-grid{
      display:flex;flex-direction:column;gap:6px;margin-bottom:8px;
    }

    .schedule-row{
      display:flex;align-items:center;gap:10px;padding:6px 8px;
      border-radius:10px;background:#020617;border:1px solid rgba(148,163,184,0.25);
    }

    .schedule-day{width:90px;font-size:13px;font-weight:500;}

    .schedule-times{
      display:flex;align-items:center;gap:6px;flex:1;flex-wrap:wrap;
    }

    .schedule-times input[type="time"]{
      width:110px;margin-bottom:0;padding:6px 8px;border-radius:8px;
    }

    .closed-label{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--muted);}

    .btn-primary{
      width:100%;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      border:0;padding:11px 12px;border-radius:12px;
      font-weight:700;font-size:14px;color:#022c22;
      cursor:pointer;margin-top:4px;
      box-shadow:0 10px 28px rgba(34,197,94,0.45);
    }

    .logout-btn{
      width:100%;background:#ef4444;color:white;border:0;
      padding:11px 12px;border-radius:12px;font-weight:600;
      font-size:14px;cursor:pointer;margin-top:8px;
    }

    @media(min-width:900px){
      body{flex-direction:row;}
      .sidebar{display:flex;}
      .top-header{display:none;}
      .main-area{margin-left:240px;padding:26px 26px 32px;}
    }
  </style>
</head>

<body>

<!-- Drawer -->
<div id="drawerOverlay" class="drawer-overlay"></div>
<div id="drawerMenu" class="drawer-menu">
  <div class="drawer-title">Cepterandevu</div>
  <div class="drawer-links">
    <a href="business-panel.html">Panel</a>
    <a href="business-services.html">Hizmetler</a>
    <a href="business-employees.html">Çalışanlar</a>
    <a href="business-appointments.html">Randevular</a>
    <a href="business-settings.html" class="active">Ayarlar</a>
  </div>
</div>

<header class="top-header">
  <div class="top-center">
    <div class="logo-mark" onclick="location.href='../index.html'">C</div>
    <span class="logo-title" id="bizNameMobile">İşletme Paneli</span>
  </div>
  <div class="top-menu-row">
    <button id="menuBtn" class="menu-btn">Menü</button>
  </div>
</header>

<aside class="sidebar">
  <div class="logo-box">
    <div class="logo-mark" onclick="location.href='../index.html'">C</div>
    <div class="biz-name-small" id="bizNameSmall">İşletme</div>
  </div>
  <div class="menu">
    <button onclick="location.href='business-panel.html'">Panel</button>
    <button onclick="location.href='business-services.html'">Hizmetler</button>
    <button onclick="location.href='business-employees.html'">Çalışanlar</button>
    <button onclick="location.href='business-appointments.html'">Randevular</button>
    <button class="active">Ayarlar</button>
  </div>
</aside>

<main class="main-area">

  <h1 class="page-title">Ayarlar</h1>

  <!-- İŞLETME BİLGİLERİ -->
  <section class="card">
    <h3>İşletme Bilgileri</h3>

    <label>Logo</label>
    <div class="logo-box2">
      <img id="logoPreview" class="logo-preview" src="">
      <input type="file" id="logoInput" accept="image/*" style="display:none;">
      <button class="upload-btn" onclick="document.getElementById('logoInput').click();">Logo Seç</button>
    </div>

    <label>İşletme Adı</label>
    <input id="bizNameInput">

    <div class="row-two">
      <div>
        <label>İl</label>
        <select id="citySelect">
          <option value="">İl seçiniz</option>
        </select>
      </div>
      <div>
        <label>İlçe</label>
        <select id="districtSelect" disabled>
          <option value="">Önce il seçiniz</option>
        </select>
      </div>
    </div>

    <label>Telefon</label>
    <input id="bizPhoneInput">

    <label>Adres</label>
    <textarea id="bizAddressInput"></textarea>

    <label>Açıklama</label>
    <textarea id="bizAboutInput"></textarea>

    <button id="saveBizBtn" class="btn-primary">İşletme Bilgilerini Kaydet</button>
  </section>


  <!-- ÇALIŞMA SAATLERİ -->
  <section class="card">
    <h3>Çalışma Saatleri</h3>
    <p class="schedule-info">
      Haftanın her günü için açılış ve kapanış saatini belirleyin.
    </p>

    <div id="scheduleRows" class="schedule-grid"></div>

    <button id="saveScheduleBtn" class="btn-primary">Çalışma Saatlerini Kaydet</button>
  </section>


  <section class="card">
    <h3>Şifre Değiştir</h3>
    <label>Yeni Şifre</label>
    <input type="password" id="newPassInput">
    <button id="savePassBtn" class="btn-primary">Şifreyi Güncelle</button>
  </section>

  <button id="logoutBtn" class="logout-btn">Çıkış Yap</button>

</main>

<script>
  const drawer = document.getElementById("drawerMenu");
  const overlay = document.getElementById("drawerOverlay");
  const menuBtn = document.getElementById("menuBtn");

  function openDrawer(){ drawer.classList.add("drawer-open"); overlay.style.display = "block"; }
  function closeDrawer(){ drawer.classList.remove("drawer-open"); overlay.style.display = "none"; }

  if(menuBtn){ menuBtn.addEventListener("click", openDrawer); }
  if(overlay){ overlay.addEventListener("click", closeDrawer); }
</script>

<script type="module">
  import { firebaseConfig } from "../js/firebase-config.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, updatePassword, signOut }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const DEFAULT_LOGO =
    'data:image/svg+xml;utf8,' +
    '<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">' +
    '<rect width="256" height="256" fill="%23020a1b"/>' +
    '<rect x="28" y="28" width="200" height="200" rx="36" fill="none" stroke="%2322c55e" stroke-width="4"/>' +
    '<text x="50%" y="52%" text-anchor="middle" dominant-baseline="middle" font-size="40" fill="%2322c55e">Logo</text>' +
    '</svg>';

  /* TÜRKİYE İL / İLÇE LİSTESİ (KISALTILMIŞ) */
  const TR_CITIES = [
    { name:"Adana", districts:["Çukurova","Seyhan","Yüreğir","Ceyhan","Kozan","Karaisalı","Karataş","Pozantı","Sarıçam","İmamoğlu","Aladağ","Feke","Saimbeyli","Tufanbeyli","Yumurtalık"] },
    { name:"Adıyaman", districts:["Merkez","Besni","Çelikhan","Gerger","Gölbaşı","Kahta","Samsat","Sincik","Tut"] },
    { name:"Afyonkarahisar", districts:["Merkez","Başmakçı","Bayat","Bolvadin","Çay","Çobanlar","Dazkırı","Dinar","Emirdağ","Evciler","Hocalar","İhsaniye","İscehisar","Kızılören","Sandıklı","Sinanpaşa","Sultandağı","Şuhut"] },
    { name:"Ankara", districts:["Altındağ","Çankaya","Keçiören","Mamak","Sincan","Yenimahalle","Etimesgut","Gölbaşı","Pursaklar","Polatlı","Beypazarı","Elmadağ","Kızılcahamam","Çubuk","Kazán","Ayaş","Nallıhan","Şereflikoçhisar","Haymana","Bala","Kalecik","Akyurt","Güdül","Evren"] },
    { name:"Antalya", districts:["Muratpaşa","Kepez","Konyaaltı","Alanya","Manavgat","Serik","Kemer","Kumluca","Finike","Demre","Kaş","Gazipaşa","İbradı","Akseki","Elmalı","Gündoğmuş","Korkuteli"] },
    { name:"Bursa", districts:["Osmangazi","Yıldırım","Nilüfer","İnegöl","Gemlik","Mudanya","Gürsu","Kestel","Karacabey","Mustafakemalpaşa","Yenişehir","İznik","Orhangazi","Orhaneli","Keles","Harmancık","Büyükorhan"] },
    { name:"İstanbul", districts:[
      "Adalar","Arnavutköy","Ataşehir","Avcılar","Bağcılar","Bahçelievler","Bakırköy","Başakşehir","Bayrampaşa",
      "Beşiktaş","Beykoz","Beylikdüzü","Beyoğlu","Büyükçekmece","Çatalca","Çekmeköy","Esenler","Esenyurt","Eyüpsultan",
      "Fatih","Gaziosmanpaşa","Güngören","Kadıköy","Kağıthane","Kartal","Küçükçekmece","Maltepe","Pendik","Sancaktepe",
      "Sarıyer","Silivri","Sultanbeyli","Sultangazi","Şile","Şişli","Tuzla","Ümraniye","Üsküdar","Zeytinburnu"
    ]},
    { name:"İzmir", districts:[
      "Aliağa","Balçova","Bayındır","Bayraklı","Bergama","Beydağ","Bornova","Buca","Çeşme","Çiğli","Dikili","Foça",
      "Gaziemir","Güzelbahçe","Karabağlar","Karaburun","Karşıyaka","Kemalpaşa","Kınık","Kiraz","Konak","Menderes",
      "Menemen","Narlıdere","Ödemiş","Seferihisar","Selçuk","Tire","Torbalı","Urla"
    ]},
    { name:"Kocaeli", districts:["İzmit","Gebze","Darıca","Çayırova","Dilovası","Körfez","Derince","Başiskele","Gölcük","Karamürsel","Kartepe","Kandıra"] },
    { name:"Konya", districts:["Meram","Selçuklu","Karatay","Akşehir","Beyşehir","Çumra","Cihanbeyli","Ereğli","Ilgın","Kulu","Seydişehir","Yunak","Karapınar","Hadim","Bozkır","Doğanhisar","Hüyük","Kadınhanı","Sarayönü","Taşkent","Ahırlı","Derebucak","Emirgazi","Güneysınır","Halkapınar","Tuzlukçu","Altınekin","Akören","Yalıhüyük"] },
    { name:"Muğla", districts:["Bodrum","Fethiye","Menteşe","Milas","Marmaris","Seydikemer","Datça","Ortaca","Köyceğiz","Yatağan","Ula","Kavaklıdere"] },
    { name:"Aydın", districts:["Efeler","Didim","Kuşadası","Nazilli","Söke","Çine","Bozdoğan","Germencik","İncirliova","Karacasu","Karpuzlu","Koçarlı","Kuyucak","Sultanhisar","Yenipazar"] },
    { name:"Mersin", districts:["Akdeniz","Toroslar","Yenişehir","Mezitli","Tarsus","Erdemli","Silifke","Mut","Anamur","Gülnar","Bozyazı","Aydıncık","Çamlıyayla"] },
    { name:"Şanlıurfa", districts:["Eyyübiye","Haliliye","Karaköprü","Siverek","Viranşehir","Akçakale","Birecik","Bozova","Ceylanpınar","Halfeti","Harran","Hilvan","Suruç"] },
    { name:"Gaziantep", districts:["Şahinbey","Şehitkamil","Nizip","İslahiye","Oğuzeli","Yavuzeli","Nurdağı","Araban","Karkamış"] },
    { name:"Kayseri", districts:["Kocasinan","Melikgazi","Talas","Develi","İncesu","Yahyalı","Bünyan","Pınarbaşı","Tomarza","Sarıoğlan","Sarız","Felahiye","Hacılar","Akkışla","Özvatan","Yeşilhisar"] },
    { name:"Eskişehir", districts:["Tepebaşı","Odunpazarı","Alpu","Beylikova","Çifteler","Günyüzü","Han","İnönü","Mahmudiye","Mihalgazi","Mihalıççık","Sarıcakaya","Seyitgazi","Sivrihisar"] },
    { name:"Trabzon", districts:["Ortahisar","Akçaabat","Araklı","Arsin","Beşikdüzü","Çarşıbaşı","Çaykara","Dernekpazarı","Düzköy","Hayrat","Köprübaşı","Maçka","Of","Sürmene","Şalpazarı","Tonya","Vakfıkebir","Yomra"] },
    { name:"Samsun", districts:["Atakum","İlkadım","Canik","Tekkeköy","Bafra","Çarşamba","Terme","Vezirköprü","Havza","Ladik","Asarcık","Alaçam","Yakakent","Kavak","Ondokuzmayıs","Salıpazarı","Ayvacık"] },
    { name:"Diğer", districts:["Merkez"] }
  ];

  let BUSINESS_ID = null;
  let cityFromDB = "";
  let districtFromDB = "";

  const bizNameSmall   = document.getElementById("bizNameSmall");
  const bizNameMobile  = document.getElementById("bizNameMobile");
  const logoInput      = document.getElementById("logoInput");
  const logoPreview    = document.getElementById("logoPreview");
  const bizNameInput   = document.getElementById("bizNameInput");
  const bizPhoneInput  = document.getElementById("bizPhoneInput");
  const bizAddressInput= document.getElementById("bizAddressInput");
  const bizAboutInput  = document.getElementById("bizAboutInput");
  const citySelect     = document.getElementById("citySelect");
  const districtSelect = document.getElementById("districtSelect");
  const saveBizBtn     = document.getElementById("saveBizBtn");
  const saveScheduleBtn= document.getElementById("saveScheduleBtn");
  const scheduleRowsEl = document.getElementById("scheduleRows");

  const DAYS = [
    { key:"monday",    label:"Pazartesi" },
    { key:"tuesday",   label:"Salı" },
    { key:"wednesday", label:"Çarşamba" },
    { key:"thursday",  label:"Perşembe" },
    { key:"friday",    label:"Cuma" },
    { key:"saturday",  label:"Cumartesi" },
    { key:"sunday",    label:"Pazar" }
  ];

  logoPreview.src = DEFAULT_LOGO;

  // İstersen dursun, kullanmasak da zarar vermez
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>resolve(reader.result);
      reader.onerror= reject;
      reader.readAsDataURL(file);
    });
  }

  // *** YENİ: LOGO KÜÇÜLTME + SIKISTIRMA ***
  async function resizeImage(file, maxSize = 300) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => {
        img.src = e.target.result;
      };
      reader.onerror = reject;

      img.onload = () => {
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxSize) {
            height = Math.round(height * (maxSize / width));
            width = maxSize;
          }
        } else {
          if (height > maxSize) {
            width = Math.round(width * (maxSize / height));
            height = maxSize;
          }
        }

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        const base64 = canvas.toDataURL("image/jpeg", 0.75);
        resolve(base64);
      };

      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // *** LOGO YÜKLEME HANDLER: ARTIK RESIZE KULLANIYOR ***

/* ------------------------------------------
   ZIRIL ZIRIL ÇALIŞAN LOGO KODU (FINAL)
-------------------------------------------*/

logoInput.addEventListener("change", async () => {
  const file = logoInput.files[0];
  if (!file) {
    alert("Dosya seçilemedi.");
    return;
  }

  // Auth tam READY olmadan işlem yapma
  if (!auth.currentUser || !BUSINESS_ID) {
    alert("Kullanıcı yüklenmeden logo yüklenemez. Sayfayı yenileyin.");
    return;
  }

  saveBizBtn.disabled = true;

  try {
    // 1: Küçültme
    const resized = await resizeImage(file, 300);

    // 2: Ekrana önizleme
    logoPreview.src = resized;

    // 3: Firestore'a yaz
    await setDoc(
      doc(db, "businesses", BUSINESS_ID),
      { logoBase64: resized },
      { merge: true }
    );

    alert("Logo başarıyla yüklendi.");
  } catch (err) {
    console.error("LOGO HATASI:", err);
    alert("Logo yüklenemedi, tekrar deneyin.");
  } finally {
    saveBizBtn.disabled = false;
  }
});


  
  logoInput.addEventListener("change", async()=>{
    const f = logoInput.files[0];

    if(!f){
      alert("Dosya seçilemedi.");
      return;
    }

    if(!BUSINESS_ID){
      alert("Kullanıcı bilgisi yüklenmeden logo yüklenemez.");
      return;
    }

    saveBizBtn.disabled = true;

    try{
      const base64 = await resizeImage(f, 300);  // ESKİ: fileToBase64(f)
      logoPreview.src = base64;

      await setDoc(doc(db,"businesses",BUSINESS_ID),{
        logoBase64:base64
      },{merge:true});

      alert("Logo güncellendi.");
    }catch(e){
      console.error(e);
      logoPreview.src = DEFAULT_LOGO;
      alert("Logo yüklenemedi.");
    }finally{
      saveBizBtn.disabled = false;
    }
  });

  function fillCities(){
    citySelect.innerHTML = `<option value="">İl seçiniz</option>`;
    TR_CITIES.forEach(c=>{
      const o = document.createElement("option");
      o.value = c.name;
      o.textContent = c.name;
      citySelect.appendChild(o);
    });

    if(cityFromDB){
      citySelect.value = cityFromDB;
      fillDistricts(cityFromDB, districtFromDB);
    }else{
      districtSelect.innerHTML = `<option value="">Önce il seçiniz</option>`;
      districtSelect.disabled = true;
    }
  }

  function fillDistricts(cityName, selected = ""){
    districtSelect.innerHTML = "";

    if(!cityName){
      districtSelect.innerHTML = `<option value="">Önce il seçiniz</option>`;
      districtSelect.disabled = true;
      return;
    }

    const c = TR_CITIES.find(x=>x.name === cityName);
    if(!c || !c.districts || !c.districts.length){
      districtSelect.innerHTML = `<option value="">İlçe bulunamadı</option>`;
      districtSelect.disabled = true;
      return;
    }

    districtSelect.disabled = false;
    districtSelect.innerHTML = `<option value="">İlçe seçiniz</option>`;

    c.districts.forEach(d=>{
      const o = document.createElement("option");
      o.value = d;
      o.textContent = d;
      districtSelect.appendChild(o);
    });

    if(selected){
      districtSelect.value = selected;
    }
  }

  citySelect.addEventListener("change",()=>{
    cityFromDB = citySelect.value;
    districtFromDB = "";
    fillDistricts(cityFromDB);
  });

  function buildScheduleRows(){
    scheduleRowsEl.innerHTML="";
    DAYS.forEach(d=>{
      const row=document.createElement("div");
      row.className="schedule-row";
      row.innerHTML=`
        <div class="schedule-day">${d.label}</div>
        <div class="schedule-times">
          <input type="time" id="start_${d.key}">
          <span>–</span>
          <input type="time" id="end_${d.key}">
          <label class="closed-label">
            <input type="checkbox" id="closed_${d.key}">
            Kapalı
          </label>
        </div>`;
      scheduleRowsEl.appendChild(row);
    });
  }

  buildScheduleRows();

  function fillScheduleFromDB(sch){
    sch = sch || {};
    DAYS.forEach(d=>{
      const cfg = sch[d.key] || {};
      document.getElementById(`start_${d.key}`).value = cfg.start || "";
      document.getElementById(`end_${d.key}`).value   = cfg.end   || "";
      document.getElementById(`closed_${d.key}`).checked = !!cfg.closed;
    });
  }

  function collectScheduleFromUI(){
    const out={};
    DAYS.forEach(d=>{
      const start = document.getElementById(`start_${d.key}`).value;
      const end   = document.getElementById(`end_${d.key}`).value;
      const closed= document.getElementById(`closed_${d.key}`).checked;

      if(!start || !end) out[d.key] = { start:"", end:"", closed:true };
      else out[d.key] = { start, end, closed };
    });
    return out;
  }

  async function loadBusiness(){
    const ref = doc(db,"businesses",BUSINESS_ID);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      fillCities();
      return;
    }

    const d = snap.data();

    bizNameSmall.textContent  = d.name || "İşletme";
    bizNameMobile.textContent = d.name || "İşletme";

    bizNameInput.value    = d.name    || "";
    bizPhoneInput.value   = d.phone   || "";
    bizAddressInput.value = d.address || "";
    bizAboutInput.value   = d.about   || "";

    cityFromDB     = d.city     || "";
    districtFromDB = d.district || "";

    if(d.logoBase64) logoPreview.src = d.logoBase64;

    fillCities();
    fillScheduleFromDB(d.schedule);
  }

  saveBizBtn.addEventListener("click", async()=>{
    if(!BUSINESS_ID){
      alert("Kullanıcı oturumu bulunamadı.");
      return;
    }

    saveBizBtn.disabled=true;

    try{
      await setDoc(doc(db,"businesses",BUSINESS_ID),{
        name:bizNameInput.value.trim(),
        phone:bizPhoneInput.value.trim(),
        address:bizAddressInput.value.trim(),
        about:bizAboutInput.value.trim(),
        city:citySelect.value,
        district:districtSelect.value
      },{merge:true});

      bizNameSmall.textContent  = bizNameInput.value.trim() || "İşletme";
      bizNameMobile.textContent = bizNameInput.value.trim() || "İşletme";

      alert("İşletme bilgileri kaydedildi.");
    }catch(e){
      console.error(e);
      alert("Hata oluştu.");
    }finally{
      saveBizBtn.disabled=false;
    }
  });

  saveScheduleBtn.addEventListener("click", async()=>{
    if(!BUSINESS_ID){
      alert("Kullanıcı oturumu bulunamadı.");
      return;
    }

    const schedule = collectScheduleFromUI();

    for(const d of DAYS){
      const s = schedule[d.key];
      if(!s.closed && s.start && s.end){
        if(s.start >= s.end){
          alert(`${d.label} günü: Açılış saati kapanıştan büyük olamaz.`);
          return;
        }
      }
    }

    saveScheduleBtn.disabled=true;

    try{
      await setDoc(doc(db,"businesses",BUSINESS_ID),{
        schedule
      },{merge:true});

      alert("Çalışma saatleri kaydedildi.");
    }catch(e){
      console.error(e);
      alert("Hata oluştu.");
    }finally{
      saveScheduleBtn.disabled=false;
    }
  });

  document.getElementById("savePassBtn").addEventListener("click",async()=>{
    const p = document.getElementById("newPassInput").value;
    if(p.length<6){
      alert("Şifre en az 6 karakter olmalı.");
      return;
    }

    try{
      await updatePassword(auth.currentUser,p);
      alert("Şifre güncellendi.");
    }catch(e){
      console.error(e);
      alert("Şifre güncellenemedi. Yeniden giriş yapmanız gerekebilir.");
    }
  });

  document.getElementById("logoutBtn").addEventListener("click",async()=>{
    try{
      await signOut(auth);
      location.href="business-login.html";
    }catch(e){
      console.error(e);
    }
  });

  onAuthStateChanged(auth, async user=>{
    if(!user){
      location.href="business-login.html";
      return;
    }
    BUSINESS_ID = user.uid;
    await loadBusiness();
  });

</script>

</body>
</html>
