<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ajandam | Cepterandevu</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --accent-strong:#16a34a;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:rgba(148,163,184,0.22);
      --radius:14px;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      padding:20px;
      display:flex;
      justify-content:center;
      min-height:100vh;
    }

    .container{
      width:100%;
      max-width:1100px;
    }

    h1{
      font-size:22px;
      margin-bottom:8px;
    }

    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-bottom:14px;
    }

    /* TAKVƒ∞M KUTUSU */
    .calendar-col{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:12px;
    }

    .calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .calendar-header button{
      background:var(--accent);
      border:0;
      padding:6px 10px;
      border-radius:8px;
      font-size:12px;
      color:#022c22;
      font-weight:600;
      cursor:pointer;
    }

    .month-label{
      font-size:14px;
      font-weight:600;
    }

    .days{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      margin-bottom:4px;
      font-size:12px;
      color:var(--muted);
    }

    .cells{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }

    .cell{
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:10px;
      min-height:120px;
      padding:6px;
      position:relative;
      cursor:pointer;
      font-size:11px;
    }

    .cell:hover{
      border-color:var(--accent);
    }

    .cell .date{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .badge-closed{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(239,68,68,0.2);
      color:#fecaca;
      font-size:10px;
      margin-bottom:2px;
    }

    .badge-partial{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(234,179,8,0.15);
      color:#facc15;
      font-size:10px;
      margin-bottom:2px;
    }

    .slot{
      background:var(--accent-soft);
      margin-bottom:3px;
      padding:3px 4px;
      border-radius:6px;
      font-size:11px;
      color:#bbf7d0;
    }

    .slot strong{
      font-weight:600;
    }

    #loading{
      font-size:13px;
      color:var(--muted);
      margin-top:14px;
    }

    /* MODAL */
    #modalBg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      backdrop-filter:blur(2px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    .modal{
      width:95%;
      max-width:440px;
      background:#0f172a;
      border-radius:16px;
      border:1px solid var(--border);
      padding:12px 14px 14px;
      max-height:90vh;
      overflow:auto;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:6px;
    }

    .modal-title-wrap h3{
      margin-bottom:2px;
      font-size:17px;
    }

    .modal-date{
      font-size:12px;
      color:var(--muted);
    }

    .modal-close-icon{
      background:transparent;
      border:0;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
      padding:2px 4px;
    }

    .section-title{
      font-size:13px;
      margin-top:8px;
      margin-bottom:4px;
      color:var(--muted);
      font-weight:600;
    }

    .hours-checkbox-list{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .hour-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid rgba(148,163,184,0.4);
    }

    .hour-chip input{
      width:12px;
      height:12px;
    }

    .modal label{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      display:block;
    }

    .modal input,
    .modal select{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      margin-top:3px;
      font-size:13px;
    }

    .btn{
      padding:9px;
      border-radius:10px;
      border:0;
      width:100%;
      margin-top:9px;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
    }

    .btn-secondary{
      background:#020617;
      color:var(--muted);
      border:1px solid var(--border);
    }

    .btn-danger{
      background:#ef4444;
      color:white;
    }

    .appt-list{
      margin-top:4px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.25);
      background:#020617;
      padding:6px;
      font-size:11px;
      max-height:160px;
      overflow:auto;
    }

    .appt-item{
      padding:4px 4px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.25);
      margin-bottom:4px;
      cursor:pointer;
    }

    .appt-item:hover{
      border-color:var(--accent);
    }

    .appt-item strong{
      font-size:11px;
    }

    .appt-empty{
      font-size:11px;
      color:var(--muted);
    }

    @media(max-width:700px){
      .calendar-col{
        padding:10px;
      }
    }
  </style>
</head>

<body>
<div class="container">

  <h1>üìÖ Ajandam</h1>
  <div class="subtitle">
    Aylƒ±k takvim √ºzerinden g√ºnlere tƒ±klayarak √ßalƒ±≈üma saatlerini y√∂netebilir,
    randevu ekleyip silebilirsin. Aynƒ± saate ikinci randevuya izin verilmez.
  </div>

  <div id="loading">Takvim y√ºkleniyor...</div>

  <div id="calendarShell" style="display:none;">
    <div class="calendar-col">
      <div class="calendar-header">
        <button id="prevMonth">‚Üê</button>
        <div id="monthLabel" class="month-label"></div>
        <button id="nextMonth">‚Üí</button>
      </div>

      <div class="days">
        <div>Pzt</div><div>Sal</div><div>√áar</div><div>Per</div>
        <div>Cum</div><div>Cmt</div><div>Paz</div>
      </div>

      <div id="cells" class="cells"></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modalBg">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title-wrap">
        <h3 id="modalTitle">G√ºn planƒ±</h3>
        <div id="modalDate" class="modal-date"></div>
      </div>
      <button id="modalCloseIcon" class="modal-close-icon">‚úï</button>
    </div>

    <div id="modalInner"></div>

    <button id="modalClose" class="btn btn-secondary">Kapat</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    collection, query, where, getDocs, addDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* ---------- FIREBASE ---------- */
  const firebaseConfig = {
    apiKey:"AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
    authDomain:"cepterandevu-35fe4.firebaseapp.com",
    projectId:"cepterandevu-35fe4",
    storageBucket:"cepterandevu-35fe4.firebasestorage.app",
    messagingSenderId:"86298180836",
    appId:"1:86298180836:web:124c2004605d68b32700f1"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  /* ---------- DOM ---------- */
  const loadingEl    = document.getElementById("loading");
  const calendarShell= document.getElementById("calendarShell");
  const cellsEl      = document.getElementById("cells");
  const monthLabel   = document.getElementById("monthLabel");
  const modalBg      = document.getElementById("modalBg");
  const modalInner   = document.getElementById("modalInner");
  const modalTitle   = document.getElementById("modalTitle");
  const modalDateEl  = document.getElementById("modalDate");
  const modalClose   = document.getElementById("modalClose");
  const modalCloseIcon = document.getElementById("modalCloseIcon");

  modalClose.onclick = () => { modalBg.style.display = "none"; };
  modalCloseIcon.onclick = () => { modalBg.style.display = "none"; };

  /* ---------- GLOBAL DURUM ---------- */
  const DEFAULT_HOURS = [
    "09:00","09:30","10:00","10:30",
    "11:00","11:30","13:00","13:30",
    "14:00","14:30","15:00","15:30",
    "16:00","16:30","17:00"
  ];

  let BUSINESS_ID   = null;
  let workHours     = [];
  let currentMonth  = new Date();
  currentMonth.setDate(1);

  // G√ºnl√ºk √ßalƒ±≈üma saatleri: { "2025-11-23": ["09:00","10:00", ...], ... }
  let dayHoursMap   = {};

  onAuthStateChanged(auth, async user => {
    if (!user){
      window.location.href = "business-login.html";
      return;
    }

    BUSINESS_ID = user.uid;

    await loadBusinessSettings();
    await renderCalendar();

    loadingEl.style.display   = "none";
    calendarShell.style.display = "block";
  });

  /* ---------- GENEL SAATLER (ƒ∞≈ûLETME AYARI) ---------- */
  async function loadBusinessSettings(){
    try{
      const ref  = doc(db,"businesses",BUSINESS_ID);
      const snap = await getDoc(ref);
      if (snap.exists()){
        const d = snap.data();
        if (Array.isArray(d.workHours) && d.workHours.length > 0){
          workHours = d.workHours;
        } else {
          workHours = DEFAULT_HOURS;
        }
      } else {
        workHours = DEFAULT_HOURS;
      }
    }catch(e){
      console.error("ƒ∞≈ületme ayarlarƒ± okunamadƒ±:", e);
      workHours = DEFAULT_HOURS;
    }
  }

  /* ---------- TAKVƒ∞M RENDER ---------- */
  async function renderCalendar(){
    cellsEl.innerHTML = "";

    const year  = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    monthLabel.textContent = currentMonth.toLocaleDateString("tr-TR", {
      year:"numeric",
      month:"long"
    });

    await loadMonthDayHours(year, month);

    const firstDay = new Date(year, month, 1);
    const lastDay  = new Date(year, month + 1, 0);
    const start = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

    for (let i = 0; i < start; i++){
      const empty = document.createElement("div");
      empty.className = "cell";
      empty.style.opacity = "0.25";
      cellsEl.appendChild(empty);
    }

    for (let d = 1; d <= lastDay.getDate(); d++){
      const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.date = dateStr;

      const header = document.createElement("div");
      header.className = "date";
      header.textContent = d;
      cell.appendChild(header);

      const hoursForDay = dayHoursMap[dateStr] ?? null;
      if (hoursForDay && hoursForDay.length === 0){
        const badge = document.createElement("div");
        badge.className = "badge-closed";
        badge.textContent = "Kapalƒ±";
        cell.appendChild(badge);
      } else if (hoursForDay && hoursForDay.length > 0 && hoursForDay.length < workHours.length){
        const badge = document.createElement("div");
        badge.className = "badge-partial";
        badge.textContent = "Kƒ±smi √ßalƒ±≈üma";
        cell.appendChild(badge);
      }

      await loadAppointmentsForDay(dateStr, cell);

      cell.addEventListener("click", () => {
        openDayModal(dateStr);
      });

      cellsEl.appendChild(cell);
    }
  }

  /* ---------- AYLIK G√úNL√úK SAATLERƒ∞ √áEK ---------- */
  async function loadMonthDayHours(year, month){
    dayHoursMap = {};

    const startDate = `${year}-${String(month+1).padStart(2,"0")}-01`;
    const endDate   = `${year}-${String(month+1).padStart(2,"0")}-31`;

    try{
      const qRef = query(
        collection(db,"businessDayHours"),
        where("businessID","==",BUSINESS_ID),
        where("date",">=",startDate),
        where("date","<=",endDate)
      );
      const snap = await getDocs(qRef);
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        if (d.date){
          dayHoursMap[d.date] = Array.isArray(d.hours) ? d.hours : [];
        }
      });
    }catch(e){
      console.error("G√ºnl√ºk saatler okunamadƒ±:", e);
    }
  }

  /* ---------- Bƒ∞R G√úN√úN RANDEVULARINI H√úCREYE YAZ ---------- */
  async function loadAppointmentsForDay(dateStr, cell){
    try{
      const appts = await fetchAppointmentsForDate(dateStr);
      appts.forEach(ap=>{
        const slot = document.createElement("div");
        slot.className = "slot";
        const cust  = ap.customerName || "M√º≈üteri";
        const serv  = ap.serviceName  || "Hizmet";
        const emp   = ap.employeeName || "";
        slot.innerHTML = `<strong>${ap.time}</strong> ¬∑ ${cust}<br><span style="color:#a5b4fc;">${serv}${emp ? " ¬∑ " + emp : ""}</span>`;
        slot.addEventListener("click", (e)=>{
          e.stopPropagation();
          openDayModal(dateStr); // Detay ve silme aynƒ± modalde
        });
        cell.appendChild(slot);
      });
    }catch(e){
      console.error("Randevular okunamadƒ±:", e);
    }
  }

  async function fetchAppointmentsForDate(dateStr){
    const list = [];
    try{
      const qRef = query(
        collection(db,"appointments"),
        where("businessID","==",BUSINESS_ID),
        where("date","==",dateStr)
      );
      const snap = await getDocs(qRef);
      snap.forEach(docSnap=>{
        list.push({id:docSnap.id, ...docSnap.data()});
      });
      list.sort((a,b)=> (a.time||"").localeCompare(b.time||""));
    }catch(e){
      console.error(e);
    }
    return list;
  }

  /* ---------- G√úN MODALI: SAAT AYARI + RANDEVU Lƒ∞STESƒ∞ + YENƒ∞ RANDEVU ---------- */
  async function openDayModal(dateStr){
    modalTitle.textContent = "G√ºn planƒ±";
    modalDateEl.textContent = dateStr;

    const hoursForDay = dayHoursMap[dateStr] ?? null;
    const activeHours = hoursForDay === null ? workHours : hoursForDay;

    const appts = await fetchAppointmentsForDate(dateStr);

    modalInner.innerHTML = "";

    // √áalƒ±≈üma saatleri
    const sec1 = document.createElement("div");
    sec1.innerHTML = `<div class="section-title">Bu g√ºn √ßalƒ±≈üƒ±lan saatler</div>`;
    const listDiv = document.createElement("div");
    listDiv.className = "hours-checkbox-list";

    workHours.forEach(h=>{
      const chip = document.createElement("label");
      chip.className = "hour-chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = h;
      cb.checked = activeHours.includes(h);

      chip.appendChild(cb);
      chip.appendChild(document.createTextNode(h));
      listDiv.appendChild(chip);
    });

    sec1.appendChild(listDiv);

    const btnSaveHours = document.createElement("button");
    btnSaveHours.className = "btn";
    btnSaveHours.textContent = "√áalƒ±≈üma saatlerini kaydet";
    btnSaveHours.onclick = async () => {
      const selected = Array.from(listDiv.querySelectorAll("input[type=checkbox]"))
        .filter(x => x.checked)
        .map(x => x.value);

      try{
        await setDoc(
          doc(db,"businessDayHours", `${BUSINESS_ID}_${dateStr}`),
          {
            businessID: BUSINESS_ID,
            date: dateStr,
            hours: selected
          },
          { merge:true }
        );
        dayHoursMap[dateStr] = selected;
        alert("G√ºn √ßalƒ±≈üma saatleri kaydedildi.");
        await renderCalendar();
      }catch(e){
        console.error(e);
        alert("Saatler kaydedilirken hata olu≈ütu.");
      }
    };
    sec1.appendChild(btnSaveHours);

    modalInner.appendChild(sec1);

    // Randevu listesi
    const sec2 = document.createElement("div");
    sec2.innerHTML = `<div class="section-title">Bu g√ºndeki randevular</div>`;
    const apptBox = document.createElement("div");
    apptBox.className = "appt-list";

    if (appts.length === 0){
      const empty = document.createElement("div");
      empty.className = "appt-empty";
      empty.textContent = "Bu g√ºne kayƒ±tlƒ± randevu yok.";
      apptBox.appendChild(empty);
    } else {
      appts.forEach(ap=>{
        const item = document.createElement("div");
        item.className = "appt-item";
        item.innerHTML = `
          <div><strong>${ap.time}</strong> ¬∑ ${ap.customerName || "M√º≈üteri"}</div>
          <div>${ap.serviceName || "Hizmet"}${ap.employeeName ? " ¬∑ " + ap.employeeName : ""}</div>
          <div style="color:#f97373;font-size:10px;margin-top:2px;">Silmek i√ßin tƒ±klayƒ±n</div>
        `;
        item.onclick = async () => {
          if (!confirm("Bu randevuyu silmek istiyor musunuz?")) return;
          try{
            await deleteDoc(doc(db,"appointments", ap.id));
            alert("Randevu silindi.");
            openDayModal(dateStr);        // modal i√ßini yeniden doldur
            await renderCalendar();       // takvimi tazele
          }catch(e){
            console.error(e);
            alert("Randevu silinemedi.");
          }
        };
        apptBox.appendChild(item);
      });
    }

    sec2.appendChild(apptBox);
    modalInner.appendChild(sec2);

    // Yeni randevu ekleme
    const sec3 = document.createElement("div");
    sec3.innerHTML = `<div class="section-title">Elle yeni randevu ekle</div>`;

    const labelTime = document.createElement("label");
    labelTime.textContent = "Saat";
    const selTime = document.createElement("select");
    selTime.id = "newTime";

    const baseHours = dayHoursMap[dateStr] === null || dayHoursMap[dateStr] === undefined
      ? workHours
      : dayHoursMap[dateStr];

    baseHours.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      selTime.appendChild(opt);
    });

    labelTime.appendChild(selTime);
    sec3.appendChild(labelTime);

    const labelCust = document.createElement("label");
    labelCust.textContent = "M√º≈üteri adƒ±";
    const inpCust = document.createElement("input");
    inpCust.id = "newCust";
    inpCust.placeholder = "Ad soyad";
    labelCust.appendChild(inpCust);
    sec3.appendChild(labelCust);

    const labelServ = document.createElement("label");
    labelServ.textContent = "Hizmet";
    const inpServ = document.createElement("input");
    inpServ.id = "newServ";
    inpServ.placeholder = "√ñrn: Sa√ß kesim";
    labelServ.appendChild(inpServ);
    sec3.appendChild(labelServ);

    const labelEmp = document.createElement("label");
    labelEmp.textContent = "√áalƒ±≈üan";
    const inpEmp = document.createElement("input");
    inpEmp.id = "newEmp";
    inpEmp.placeholder = "√áalƒ±≈üan adƒ±";
    labelEmp.appendChild(inpEmp);
    sec3.appendChild(labelEmp);

    const btnAdd = document.createElement("button");
    btnAdd.className = "btn";
    btnAdd.textContent = "Randevu ekle";
    btnAdd.onclick = async () => {
      const time = selTime.value;
      const customerName = inpCust.value.trim();
      const serviceName  = inpServ.value.trim();
      const employeeName = inpEmp.value.trim();

      if (!time || !customerName || !serviceName){
        alert("Saat, m√º≈üteri adƒ± ve hizmet zorunlu.");
        return;
      }

      // ‚ùó Aynƒ± saate ikinci randevuyu engelle
      const existing = await fetchAppointmentsForDate(dateStr);
      const hasSameTime = existing.some(a => (a.time || "") === time);
      if (hasSameTime){
        alert("Bu saat i√ßin zaten bir randevu var. Aynƒ± saate ikinci randevu olu≈üturamazsƒ±nƒ±z.");
        return;
      }

      try{
        await addDoc(collection(db,"appointments"), {
          businessID:  BUSINESS_ID,
          date:        dateStr,
          time,
          customerName,
          serviceName,
          employeeName,
          status: "approved",
          createdAt: Date.now()
        });
        alert("Randevu eklendi.");
        openDayModal(dateStr);    // modal i√ßini g√ºncelle
        await renderCalendar();   // takvimi tazele
      }catch(e){
        console.error(e);
        alert("Randevu eklenemedi.");
      }
    };

    sec3.appendChild(btnAdd);
    modalInner.appendChild(sec3);

    modalBg.style.display = "flex";
  }

  /* ---------- AY GE√áƒ∞≈û BUTONLARI ---------- */
  document.getElementById("prevMonth").addEventListener("click", async ()=>{
    currentMonth.setMonth(currentMonth.getMonth()-1);
    await renderCalendar();
  });

  document.getElementById("nextMonth").addEventListener("click", async ()=>{
    currentMonth.setMonth(currentMonth.getMonth()+1);
    await renderCalendar();
  });
</script>

</body>
</html>
