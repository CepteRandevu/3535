<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ajandam | Cepterandevu</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.18);
      --accent-strong:#16a34a;
      --text:#f9faff;
      --muted:#94a3b8;
      --border:rgba(148,163,184,0.25);
      --radius:16px;
      --danger:#ef4444;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .container{
      width:100%;
      max-width:1120px;
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .logo-group{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo-mark{
      width:32px;
      height:32px;
      border-radius:14px;
      background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ecfdf5;
      font-weight:800;
      font-size:18px;
      box-shadow:0 10px 30px rgba(34,197,94,0.6);
    }

    .logo-text-main{
      font-weight:700;
      font-size:16px;
      letter-spacing:0.04em;
    }

    .logo-text-sub{
      font-size:11px;
      color:var(--muted);
    }

    .title-wrap h1{
      font-size:20px;
      margin-bottom:2px;
    }

    .title-wrap p{
      font-size:12px;
      color:var(--muted);
    }

    .pill-soft{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(34,197,94,0.16);
      color:#bbf7d0;
      font-size:11px;
      border:1px solid rgba(34,197,94,0.5);
    }

    /* TAKVİM KARTI */
    .agenda-card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:12px;
      margin-top:10px;
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
    }

    .calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:10px;
    }

    .month-label{
      font-size:15px;
      font-weight:600;
    }

    .nav-buttons{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .btn-nav{
      border:0;
      border-radius:10px;
      background:#020617;
      color:var(--muted);
      padding:5px 9px;
      font-size:12px;
      cursor:pointer;
      border:1px solid var(--border);
    }

    .btn-nav:hover{
      border-color:var(--accent);
      color:var(--text);
    }

    .calendar-grid{
      margin-top:6px;
    }

    .weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
      padding:0 2px;
    }

    .weekdays div{
      text-align:center;
      padding-bottom:4px;
    }

    .days-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }

    .day-cell{
      background:#020617;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.9);
      min-height:96px;
      padding:6px 5px;
      position:relative;
      cursor:pointer;
      transition:border-color 0.16s ease, transform 0.1s ease;
    }

    .day-cell:hover{
      border-color:var(--accent);
      transform:translateY(-1px);
    }

    .day-cell.disabled{
      opacity:.25;
      cursor:default;
    }

    .day-number{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .appt-count{
      font-size:10px;
      color:#a5b4fc;
      margin-bottom:4px;
    }

    .slot-mini{
      font-size:10px;
      background:var(--accent-soft);
      border-radius:6px;
      padding:2px 4px;
      color:#bbf7d0;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge-today{
      position:absolute;
      top:6px;
      right:6px;
      font-size:9px;
      padding:2px 5px;
      border-radius:999px;
      background:rgba(59,130,246,0.18);
      color:#bfdbfe;
    }

    #loading{
      font-size:13px;
      color:var(--muted);
      margin-top:14px;
    }

    /* MODAL */
    #modalBg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      backdrop-filter:blur(3px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:999;
    }

    .modal{
      width:95%;
      max-width:460px;
      max-height:90vh;
      overflow:auto;
      background:#020617;
      border-radius:16px;
      border:1px solid var(--border);
      padding:12px 14px 14px;
      box-shadow:0 24px 70px rgba(0,0,0,0.8);
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:6px;
    }

    .modal-title-wrap h3{
      font-size:17px;
      margin-bottom:2px;
    }

    .modal-date{
      font-size:12px;
      color:var(--muted);
    }

    .modal-close-icon{
      background:transparent;
      border:0;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
      padding:2px 4px;
    }

    .section-title{
      font-size:13px;
      color:var(--muted);
      margin-top:8px;
      margin-bottom:4px;
      font-weight:600;
    }

    .appt-list{
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.4);
      background:#020617;
      padding:6px;
      font-size:11px;
      max-height:170px;
      overflow:auto;
    }

    .appt-item{
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.4);
      padding:4px 5px;
      margin-bottom:4px;
      cursor:pointer;
    }

    .appt-item:hover{
      border-color:var(--accent);
    }

    .appt-empty{
      font-size:11px;
      color:var(--muted);
    }

    .appt-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2px;
    }

    .appt-time{
      font-weight:600;
      color:#bbf7d0;
      font-size:11px;
    }

    .appt-caption{
      font-size:10px;
      color:#fca5a5;
    }

    .badge-status{
      font-size:10px;
      padding:1px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      color:#e5e7eb;
    }

    .badge-status.pending{
      border-color:#facc15;
      color:#facc15;
    }
    .badge-status.approved{
      border-color:#22c55e;
      color:#4ade80;
    }

    .modal label{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      display:block;
    }

    .modal input,
    .modal select{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      margin-top:3px;
      font-size:13px;
    }

    .btn{
      width:100%;
      padding:9px;
      border-radius:10px;
      border:0;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;
      box-shadow:0 12px 30px rgba(34,197,94,0.4);
    }

    .btn-secondary{
      background:#020617;
      color:var(--muted);
      border:1px solid var(--border);
    }

    .btn-danger{
      background:var(--danger);
      color:#fff;
    }

    .error-text{
      font-size:11px;
      color:#fecaca;
      margin-top:4px;
      display:none;
    }

    /* MOBİL ADAPTASYON */
    @media (max-width:768px){
      body{
        padding:12px;
      }

      .agenda-card{
        padding:10px;
      }

      .day-cell{
        min-height:72px;
        padding:5px 4px;
      }

      .slot-mini{
        font-size:9px;
      }

      .top-bar{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }

      .modal{
        max-width:100%;
        width:100%;
        border-radius:18px 18px 0 0;
        position:fixed;
        bottom:0;
        left:0;
        right:0;
      }
    }
  </style>
</head>

<body>
<div class="container">

  <div class="top-bar">
    <div class="logo-group">
      <div class="logo-mark">C</div>
      <div>
        <div class="logo-text-main">Cepterandevu</div>
        <div class="logo-text-sub">İşletme ajandanız</div>
      </div>
    </div>
    <div class="title-wrap">
      <h1>Ajandam</h1>
      <p>Günlere tıklayarak randevuları görüntüleyebilir, yeni randevu ekleyip silebilirsiniz.</p>
    </div>
  </div>

  <span class="pill-soft">Aynı saate ikinci randevuya izin verilmez.</span>

  <div id="loading">Takvim yükleniyor...</div>

  <div id="agendaWrap" class="agenda-card" style="display:none;">
    <div class="calendar-header">
      <div class="month-label" id="monthLabel"></div>
      <div class="nav-buttons">
        <button id="prevMonth" class="btn-nav">Önceki</button>
        <button id="nextMonth" class="btn-nav">Sonraki</button>
      </div>
    </div>

    <div class="calendar-grid">
      <div class="weekdays">
        <div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div>
        <div>Cum</div><div>Cmt</div><div>Paz</div>
      </div>
      <div class="days-grid" id="daysGrid"></div>
    </div>
  </div>

</div>

<!-- MODAL -->
<div id="modalBg">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title-wrap">
        <h3 id="modalTitle">Gün detayları</h3>
        <div id="modalDate" class="modal-date"></div>
      </div>
      <button id="modalCloseIcon" class="modal-close-icon">✕</button>
    </div>

    <div id="modalInner"></div>

    <button id="modalCloseBtn" class="btn btn-secondary">Kapat</button>
  </div>
</div>

<script type="module">
  import { firebaseConfig } from "../js/firebase-config.js";
  import { AgendaUtils }    from "../js/ajanda-utils.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  /* ---------- SABİT GENEL ÇALIŞMA SAATLERİ (AJANDA İÇİN) ---------- */
  const DEFAULT_HOURS = [
    "09:00","09:30","10:00","10:30",
    "11:00","11:30","13:00","13:30",
    "14:00","14:30","15:00","15:30",
    "16:00","16:30","17:00"
  ];
  AgendaUtils.cache.workHours = DEFAULT_HOURS;

  /* ---------- DOM ---------- */
  const loadingEl   = document.getElementById("loading");
  const agendaWrap  = document.getElementById("agendaWrap");
  const daysGrid    = document.getElementById("daysGrid");
  const monthLabel  = document.getElementById("monthLabel");

  const modalBg       = document.getElementById("modalBg");
  const modalTitle    = document.getElementById("modalTitle");
  const modalDateEl   = document.getElementById("modalDate");
  const modalInner    = document.getElementById("modalInner");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const modalCloseIcon= document.getElementById("modalCloseIcon");

  let BUSINESS_ID = null;
  let currentMonth = new Date();
  currentMonth.setDate(1);

  /* ---------- MODAL KAPATMA ---------- */
  function closeModal(){
    modalBg.style.display = "none";
  }
  modalCloseBtn.addEventListener("click", closeModal);
  modalCloseIcon.addEventListener("click", closeModal);

  /* ---------- AUTH ---------- */
  onAuthStateChanged(auth, async user => {
    if (!user){
      window.location.href = "business-login.html";
      return;
    }
    BUSINESS_ID = user.uid;

    await AgendaUtils.loadMonth(db, BUSINESS_ID, currentMonth);
    renderCalendar();

    loadingEl.style.display = "none";
    agendaWrap.style.display = "block";
  });

  /* ---------- TAKVİM ÇİZ ---------- */
  function renderCalendar(){
    daysGrid.innerHTML = "";

    const year  = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    monthLabel.textContent = currentMonth.toLocaleDateString("tr-TR", {
      year: "numeric",
      month: "long"
    });

    const days = AgendaUtils.generateMonthDays(currentMonth);

    const todayStr = new Date().toISOString().slice(0,10);

    days.forEach(d=>{
      if (d.type === "empty"){
        const div = document.createElement("div");
        div.className = "day-cell disabled";
        daysGrid.appendChild(div);
        return;
      }

      const cell = document.createElement("div");
      cell.className = "day-cell";
      cell.dataset.date = d.dateStr;

      const num = document.createElement("div");
      num.className = "day-number";
      num.textContent = d.day;
      cell.appendChild(num);

      if (d.dateStr === todayStr){
        const badge = document.createElement("div");
        badge.className = "badge-today";
        badge.textContent = "Bugün";
        cell.appendChild(badge);
      }

      const appts = AgendaUtils.getAppointmentsForDay(d.dateStr);
      if (appts.length > 0){
        const count = document.createElement("div");
        count.className = "appt-count";
        count.textContent = `${appts.length} randevu`;
        cell.appendChild(count);

        const maxShow = 2;
        appts.slice(0,maxShow).forEach(a=>{
          const mini = document.createElement("div");
          mini.className = "slot-mini";
          const cust = a.customerName || "Müşteri";
          mini.textContent = `${a.time} · ${cust}`;
          cell.appendChild(mini);
        });

        if (appts.length > maxShow){
          const extra = document.createElement("div");
          extra.className = "slot-mini";
          extra.textContent = `+${appts.length - maxShow} daha`;
          cell.appendChild(extra);
        }
      }

      cell.addEventListener("click", ()=>{
        openDayModal(d.dateStr);
      });

      daysGrid.appendChild(cell);
    });
  }

  /* ---------- GÜN HÜCRESİNİ TEK BAŞINA GÜNCELLE ---------- */
  function refreshDayCell(dateStr){
    const cell = daysGrid.querySelector(`.day-cell[data-date="${dateStr}"]`);
    if (!cell) return;

    // header dışındakileri temizle
    const keep = [];
    cell.childNodes.forEach((node, idx)=>{
      if (idx === 0 || node.classList?.contains("badge-today")) keep.push(node);
    });
    cell.innerHTML = "";
    keep.forEach(k=>cell.appendChild(k));

    const appts = AgendaUtils.getAppointmentsForDay(dateStr);
    if (appts.length > 0){
      const count = document.createElement("div");
      count.className = "appt-count";
      count.textContent = `${appts.length} randevu`;
      cell.appendChild(count);

      const maxShow = 2;
      appts.slice(0,maxShow).forEach(a=>{
        const mini = document.createElement("div");
        mini.className = "slot-mini";
        const cust = a.customerName || "Müşteri";
        mini.textContent = `${a.time} · ${cust}`;
        cell.appendChild(mini);
      });

      if (appts.length > maxShow){
        const extra = document.createElement("div");
        extra.className = "slot-mini";
        extra.textContent = `+${appts.length - maxShow} daha`;
        cell.appendChild(extra);
      }
    }
  }

  /* ---------- GÜN MODALI ---------- */
  async function openDayModal(dateStr){
    modalTitle.textContent = "Gün detayları";
    modalDateEl.textContent = AgendaUtils.formatDateHuman(dateStr);

    const appts = AgendaUtils.getAppointmentsForDay(dateStr).slice()
      .sort((a,b)=>(a.time||"").localeCompare(b.time||""));

    modalInner.innerHTML = "";

    // Randevu listesi
    const sec1 = document.createElement("div");
    sec1.innerHTML = `<div class="section-title">Bu gündeki randevular</div>`;
    const listBox = document.createElement("div");
    listBox.className = "appt-list";

    if (appts.length === 0){
      const empty = document.createElement("div");
      empty.className = "appt-empty";
      empty.textContent = "Bu güne kayıtlı randevu yok.";
      listBox.appendChild(empty);
    } else {
      appts.forEach(ap=>{
        const item = document.createElement("div");
        item.className = "appt-item";

        const header = document.createElement("div");
        header.className = "appt-item-header";

        const left = document.createElement("div");
        left.innerHTML = `<span class="appt-time">${ap.time}</span> · ${ap.customerName || "Müşteri"}`;

        const right = document.createElement("div");
        const statusSpan = document.createElement("span");
        statusSpan.className = "badge-status " + (ap.status || "pending");
        statusSpan.textContent = ap.status === "approved" ? "Onaylı" : "Beklemede";
        right.appendChild(statusSpan);

        header.appendChild(left);
        header.appendChild(right);

        const line2 = document.createElement("div");
        line2.style.fontSize = "10px";
        line2.style.color   = "#e5e7eb";
        line2.textContent   = `${ap.serviceName || "Hizmet"}${ap.employeeName ? " · " + ap.employeeName : ""}`;

        const line3 = document.createElement("div");
        line3.className = "appt-caption";
        line3.textContent = "Silmek için tıklayın";

        item.appendChild(header);
        item.appendChild(line2);
        item.appendChild(line3);

        item.addEventListener("click", async ()=>{
          if (!confirm("Bu randevuyu silmek istiyor musunuz?")) return;
          try{
            await AgendaUtils.deleteAppointment(db, ap.id, dateStr);
            alert("Randevu silindi.");
            // listeyi yeniden oluştur
            openDayModal(dateStr);
            refreshDayCell(dateStr);
          }catch(e){
            console.error(e);
            alert("Randevu silinirken hata oluştu.");
          }
        });

        listBox.appendChild(item);
      });
    }

    sec1.appendChild(listBox);
    modalInner.appendChild(sec1);

    // Elle randevu ekleme
    const sec2 = document.createElement("div");
    sec2.innerHTML = `<div class="section-title">Elle yeni randevu ekle</div>`;

    const lblTime = document.createElement("label");
    lblTime.textContent = "Saat";
    const selTime = document.createElement("select");
    selTime.id = "newTime";

    DEFAULT_HOURS.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      selTime.appendChild(opt);
    });
    lblTime.appendChild(selTime);
    sec2.appendChild(lblTime);

    const lblCust = document.createElement("label");
    lblCust.textContent = "Müşteri Adı";
    const inpCust = document.createElement("input");
    inpCust.id = "newCust";
    inpCust.placeholder = "Ad soyad";
    lblCust.appendChild(inpCust);
    sec2.appendChild(lblCust);

    const lblServ = document.createElement("label");
    lblServ.textContent = "Hizmet";
    const inpServ = document.createElement("input");
    inpServ.id = "newServ";
    inpServ.placeholder = "Örn: Saç kesim";
    lblServ.appendChild(inpServ);
    sec2.appendChild(lblServ);

    const lblEmp = document.createElement("label");
    lblEmp.textContent = "Çalışan";
    const inpEmp = document.createElement("input");
    inpEmp.id = "newEmp";
    inpEmp.placeholder = "Çalışan adı (isteğe bağlı)";
    lblEmp.appendChild(inpEmp);
    sec2.appendChild(lblEmp);

    const errorText = document.createElement("div");
    errorText.className = "error-text";
    errorText.id = "newErr";
    errorText.textContent = "Hata mesajı";
    sec2.appendChild(errorText);

    const btnAdd = document.createElement("button");
    btnAdd.className = "btn btn-primary";
    btnAdd.textContent = "Randevu ekle";

    btnAdd.addEventListener("click", async ()=>{
      errorText.style.display = "none";
      errorText.textContent   = "";

      const time = selTime.value;
      const customerName = inpCust.value.trim();
      const serviceName  = inpServ.value.trim();
      const employeeName = inpEmp.value.trim();

      if (!time || !customerName || !serviceName){
        errorText.textContent = "Saat, müşteri adı ve hizmet alanları zorunludur.";
        errorText.style.display = "block";
        return;
      }

      // Aynı saate ikinci randevu engeli
      if (AgendaUtils.isHourBusy(dateStr, time)){
        errorText.textContent = "Bu saat için zaten randevu var. Aynı saate ikinci randevu ekleyemezsiniz.";
        errorText.style.display = "block";
        return;
      }

      try{
        await AgendaUtils.addAppointment(db, {
          businessID:  BUSINESS_ID,
          date:        dateStr,
          time,
          customerName,
          serviceName,
          employeeName,
          status: "approved",
          createdAt: Date.now()
        });

        alert("Randevu eklendi.");
        // modal içeriğini güncelle + hücreyi tazele
        openDayModal(dateStr);
        refreshDayCell(dateStr);
      }catch(e){
        console.error(e);
        errorText.textContent = "Randevu eklenirken hata oluştu.";
        errorText.style.display = "block";
      }
    });

    sec2.appendChild(btnAdd);

    modalInner.appendChild(sec2);

    modalBg.style.display = "flex";
  }

  /* ---------- AY GEÇİŞ BUTONLARI ---------- */
  document.getElementById("prevMonth").addEventListener("click", async ()=>{
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    await AgendaUtils.loadMonth(db, BUSINESS_ID, currentMonth);
    renderCalendar();
  });

  document.getElementById("nextMonth").addEventListener("click", async ()=>{
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    await AgendaUtils.loadMonth(db, BUSINESS_ID, currentMonth);
    renderCalendar();
  });
</script>

</body>
</html>
