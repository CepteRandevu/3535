<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Çalışanlar | Cepterandevu</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #050816;
      --sidebar: #0b1120;
      --card: #101528;
      --accent: #22c55e;
      --accent-strong: #16a34a;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: rgba(148,163,184,0.35);
      --radius-xl: 18px;
      --shadow-soft: 0 10px 30px rgba(10, 10, 20, 0.75);
      --modal-blue: #1d4ed8;
      --modal-red: #dc2626;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #111827, #020617 55%);
      font-family: 'Inter', system-ui;
      color: var(--text);
      min-height: 100vh;
    }

    .top-header {
      width: 100%;
      padding-top: 14px;
      padding-bottom: 0;
      position: sticky;
      top: 0;
      z-index: 500;
      background: var(--sidebar);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .top-center {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .top-menu-row {
      width: 100%;
      padding-left:20px;
      padding-bottom:14px;
      display:flex;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 10%, #4ade80,#16a34a 42%,#0f766e);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;color:#ecfdf5;
    }

    .menu-btn {
      background: var(--accent);
      border:0;
      color:#022c22;
      padding:9px 15px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .sidebar {
      width:240px;background:var(--sidebar);
      padding:24px 18px;
      border-right:1px solid var(--border);
      position:fixed;top:0;bottom:0;
      display:none;flex-direction:column;
    }

    .logo-box { display:flex;gap:12px;align-items:center;margin-bottom:20px; }

    .main-area {
      padding:20px;
      padding-top:110px;
    }

    .card {
      background:var(--card);
      padding:20px;
      border-radius:var(--radius-xl);
      border:1px solid var(--border);
      margin-bottom:20px;
    }

    input {
      width:100%;padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;color:var(--text);
      margin-bottom:10px;
    }

    .btn-primary {
      width:100%;
      border:0;
      padding:12px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;
      font-weight:600;
      cursor:pointer;
    }

    .emp-row {
      border-bottom:1px solid rgba(255,255,255,0.1);
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .delete-btn {
      background:#ef4444;color:white;
      border:0;border-radius:8px;
      padding:6px 10px;font-size:12px;
    }

    /* ---------------- MODAL ---------------- */
    #modalOverlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(2px);
      z-index:99999;
    }

    #modalBox {
      background:var(--card);
      padding:22px;
      border-radius:18px;
      width:90%;
      max-width:420px;
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      animation:fadeIn .2s ease;
    }

    #serviceGrid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:16px;
    }

    .service-block {
      padding:12px;
      border-radius:12px;
      text-align:center;
      font-size:14px;
      cursor:pointer;
      background:var(--modal-blue);
    }

    .service-block.selected {
      background:var(--modal-red);
    }

    #modalSaveBtn {
      width:100%;padding:12px;
      border:0;border-radius:12px;
      background:var(--accent);
      font-weight:700;
      cursor:pointer;
      color:#022c22;
      margin-top:8px;
    }

    #modalCancelBtn {
      width:100%;padding:10px;
      background:#ef4444;
      border:0;color:#fff;
      border-radius:12px;
      margin-top:8px;
      cursor:pointer;
    }

    @keyframes fadeIn {
      from {opacity:0;transform:scale(.95);}
      to {opacity:1;transform:scale(1);}
    }

    @media(min-width:768px){
      body{flex-direction:row;}
      .sidebar{display:flex;}
      .top-header{display:none;}
      .main-area{margin-left:240px;padding-top:32px;}
    }
  </style>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>

<!-- MODAL -->
<div id="modalOverlay">
  <div id="modalBox">
    <h3 style="margin-bottom:12px;font-size:18px;font-weight:700;">Hizmetleri Seç</h3>

    <div id="serviceGrid"></div>

    <button id="modalSaveBtn">Seçimi Kaydet</button>
    <button id="modalCancelBtn">Kapat</button>
  </div>
</div>

<!-- Drawer -->
<div id="drawerOverlay" class="drawer-overlay"></div>
<div id="drawerMenu" class="drawer-menu">
  <div class="drawer-title">Cepterandevu</div>
  <div class="drawer-links">
    <a href="business-panel.html">Panel</a>
    <a href="business-services.html">Hizmetler</a>
    <a href="business-employees.html" class="active">Çalışanlar</a>
    <a href="business-appointments.html">Randevular</a>
    <a href="business-settings.html">Ayarlar</a>
  </div>
</div>

<header class="top-header">
  <div class="top-center">
    <div class="logo-mark">C</div>
    <span class="logo-title" id="bizNameMobile">Çalışanlar</span>
  </div>
  <div class="top-menu-row">
    <button id="menuBtn" class="menu-btn"><i class="fas fa-bars"></i> Menü</button>
  </div>
</header>

<aside class="sidebar">
  <div class="logo-box">
    <div class="logo-mark">C</div>
    <div id="bizNameSmallSidebar" class="biz-name-small">İşletme</div>
  </div>
  <div class="menu">
    <button onclick="location.href='business-panel.html'"><i class="fas fa-tachometer-alt"></i> Panel</button>
    <button onclick="location.href='business-services.html'"><i class="fas fa-wrench"></i> Hizmetler</button>
    <button class="active"><i class="fas fa-users"></i> Çalışanlar</button>
    <button onclick="location.href='business-appointments.html'"><i class="fas fa-calendar-alt"></i> Randevular</button>
    <button onclick="location.href='business-settings.html'"><i class="fas fa-cog"></i> Ayarlar</button>
  </div>
</aside>

<main class="main-area">
  <h1 class="title" id="bizTitle">Çalışan Yönetimi</h1>

  <div class="card">
    <h2 style="margin-bottom:10px;">Yeni Çalışan Ekle</h2>

    <label>Çalışan Adı</label>
    <input id="empNameInput" placeholder="Örn: Mehmet Usta">

    <button class="btn-primary" id="openServiceModalBtn">Hizmetleri Seç</button>

    <div id="selectedServiceText" style="color:var(--muted);font-size:13px;margin-top:8px;">
      Hizmet seçilmedi.
    </div>

    <button class="btn-primary" id="addEmpBtn">Çalışanı Kaydet</button>
  </div>

  <div class="card">
    <h2 style="margin-bottom:10px;">Mevcut Çalışanlar</h2>
    <div id="empList" class="empty">Yükleniyor...</div>
  </div>
</main>


<script type="module">
  import { firebaseConfig } from "../js/firebase-config.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    deleteDoc,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let businessID = null;
  let SERVICES = {};
  let SELECTED = [];

  const bizNameMobile = document.getElementById("bizNameMobile");
  const bizNameSmallSidebar = document.getElementById("bizNameSmallSidebar");
  const bizTitle = document.getElementById("bizTitle");

  const openServiceModalBtn = document.getElementById("openServiceModalBtn");
  const modalOverlay = document.getElementById("modalOverlay");
  const serviceGrid = document.getElementById("serviceGrid");
  const selectedServiceText = document.getElementById("selectedServiceText");

  onAuthStateChanged(auth, async user=>{
      if(!user){ location.href="business-login.html"; return; }
      businessID = user.uid;
      await loadBusinessName();
      await loadServices();
      await loadEmployees();
  });

  async function loadBusinessName(){
    const ref = doc(db,"businesses",businessID);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const name = snap.data().name || "İşletme";
      bizNameMobile.textContent = "Çalışanlar · " + name;
      bizNameSmallSidebar.textContent = name;
      bizTitle.textContent = name + " · Çalışanlar";
    }
  }

  async function loadServices(){
    const qRef = query(collection(db,"services"),where("businessID","==",businessID));
    const snap = await getDocs(qRef);

    SERVICES = {};
    serviceGrid.innerHTML = "";

    if(snap.empty){
      serviceGrid.innerHTML = `<div class="empty">Hizmet yok.</div>`;
      return;
    }

    snap.forEach(docSnap=>{
      const d = docSnap.data();
      SERVICES[docSnap.id] = d;

      const box = document.createElement("div");
      box.className = "service-block";
      box.dataset.id = docSnap.id;
      box.textContent = `${d.name} (${d.duration} dk)`;

      box.onclick = ()=>{
        box.classList.toggle("selected");
      };

      serviceGrid.appendChild(box);
    });
  }

  openServiceModalBtn.onclick = () => {
    modalOverlay.style.display = "flex";
  };

  document.getElementById("modalCancelBtn").onclick = () => {
    modalOverlay.style.display = "none";
  };

  document.getElementById("modalSaveBtn").onclick = () => {

    SELECTED = Array.from(
      document.querySelectorAll(".service-block.selected")
    ).map(div=>div.dataset.id);

    selectedServiceText.textContent = SELECTED.length
      ? SELECTED.map(id => SERVICES[id].name).join(", ")
      : "Hizmet seçilmedi.";

    modalOverlay.style.display = "none";
  };

  document.getElementById("addEmpBtn").onclick = async () => {

    const name = document.getElementById("empNameInput").value.trim();

    if(!name){ alert("Çalışan adı gerekli."); return; }
    if(SELECTED.length === 0){ alert("En az bir hizmet seçmelisiniz."); return; }

    await addDoc(collection(db,"employees"),{
      businessID,
      name,
      services: SELECTED
    });

    document.getElementById("empNameInput").value = "";
    SELECTED = [];
    selectedServiceText.textContent = "Hizmet seçilmedi.";

    await loadEmployees();
  };

  async function loadEmployees(){
    const empList = document.getElementById("empList");
    empList.textContent = "Yükleniyor...";

    const qRef = query(collection(db,"employees"),where("businessID","==",businessID));
    const snap = await getDocs(qRef);

    empList.innerHTML = "";

    if(snap.empty){
      empList.innerHTML = `<div class="empty">Henüz çalışan yok.</div>`;
      return;
    }

    snap.forEach(docSnap=>{
      const d = docSnap.data();

      const row = document.createElement("div");
      row.className = "emp-row";

      let serviceNames = (d.services||[])
        .map(id => SERVICES[id]?.name || id)
        .join(", ");

      row.innerHTML = `
        <div class="emp-info">
          <div class="emp-name">${d.name}</div>
          <div class="emp-meta">${serviceNames}</div>
        </div>
        <button class="delete-btn" data-id="${docSnap.id}">Sil</button>
      `;

      empList.appendChild(row);
    });

    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.onclick = async ()=>{
        if(!confirm("Çalışanı silmek istiyor musunuz?")) return;
        await deleteDoc(doc(db,"employees",btn.dataset.id));
        await loadEmployees();
      };
    });
  }

</script>

</body>
</html>
