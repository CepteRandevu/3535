<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Randevu Oluştur | Cepterandevu</title>

<style>
:root{
  --bg:#050816;
  --card:#0f172a;
  --accent:#22c55e;
  --text:#f1f5f9;
  --muted:#94a3b8;
  --border:rgba(148,163,184,0.18);
  --radius:16px;
}
*{margin:0;padding:0;box-sizing:border-box;}

body{
  background:radial-gradient(circle at top,#111827,#020617 55%);
  font-family:system-ui;
  color:var(--text);
  padding:16px;
  display:flex;
  justify-content:center;
  min-height:100vh;
}

.container{
  width:100%;
  max-width:960px;
}

.card{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  margin-bottom:16px;
  box-shadow:0 18px 45px rgba(15,23,42,0.85);
}

select,input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  background:#020617;
  border-radius:var(--radius);
  border:1px solid var(--border);
  color:var(--text);
}

.btn-primary{
  width:100%;
  padding:12px;
  background:linear-gradient(135deg,var(--accent),#16a34a);
  border:0;
  border-radius:var(--radius);
  font-size:15px;
  font-weight:600;
  color:#022c22;
}

.error-box{
  display:none;
  background:rgba(239,68,68,0.15);
  padding:10px;
  border-radius:14px;
  border:1px solid rgba(239,68,68,0.4);
  color:#fecaca;
  font-size:13px;
  margin-bottom:8px;
}
</style>
</head>
<body>
<div class="container">

  <div id="loading" class="card">İşletme bilgileri yükleniyor...</div>

  <div id="bookingWrap" style="display:none;">

    <!-- İŞLETME BİLGİ KARTI -->
    <div class="card">
      <h2>İşletme Bilgisi</h2>

      <div class="biz-logo-box"
        style="width:90px;height:90px;border-radius:14px;
        border:1px solid var(--border);
        background:#020617; overflow:hidden;margin-bottom:10px;">
        <img id="bizLogo" style="width:100%;height:100%;object-fit:contain;">
      </div>

      <div id="bizName" style="font-size:18px;font-weight:600;"></div>
<div id="bizLocation" style="font-size:13px;color:var(--muted);margin-top:4px;"></div>
<div id="bizMeta" style="font-size:12px;color:var(--muted);margin-top:4px;"></div>

<!-- YENİ EKLENENLER -->
<div id="bizAddress"
     style="font-size:12px;color:var(--muted);margin-top:4px;"></div>

<div id="bizDesc"
     style="font-size:12px;color:var(--muted);margin-top:4px;"></div>


    <!-- RANDEVU OLUŞTURMA FORMU -->
    <div class="card">
      <h2>Randevu Oluştur</h2>

      <div id="errorBox" class="error-box"></div>

      <label>Hizmet</label>
      <select id="serviceSelect">
        <option>Yükleniyor...</option>
      </select>

      <label>Çalışan</label>
      <select id="employeeSelect">
        <option>Önce hizmet seçin</option>
      </select>

      <label>Tarih</label>
      <input type="date" id="dateInput">

      <label>Saat</label>
      <select id="timeSelect"></select>

      <button id="createBtn" class="btn-primary">Randevuyu Oluştur</button>
    </div>

  </div>
</div>
<script type="module">

/* ------------------- FIREBASE ------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection,
  query, where, getDocs, addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const DEFAULT_BIZ_LOGO =
'data:image/svg+xml;utf8,' +
'<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 256 256">' +
'<rect width="256" height="256" fill="%23020a1b"/>' +
'<rect x="28" y="28" width="200" height="200" rx="36" fill="none" stroke="%2322c55e" stroke-width="4"/>' +
'<text x="50%" y="52%" text-anchor="middle" dominant-baseline="middle"' +
' font-family="system-ui" font-size="38" fill="%2322c55e">C</text>' +
'</svg>';

const firebaseConfig = {
  apiKey:"AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
  authDomain:"cepterandevu-35fe4.firebaseapp.com",
  projectId:"cepterandevu-35fe4",
  storageBucket:"cepterandevu-35fe4.firebasestorage.app",
  messagingSenderId:"86298180836",
  appId:"1:86298180836:web:124c2004605d68b32700f1",
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth= getAuth(app);

/* ------------------- ELEMENTLER ------------------- */

const businessId = new URLSearchParams(location.search).get("businessId");

const bizLogoEl     = document.getElementById("bizLogo");
const bizNameEl     = document.getElementById("bizName");
const bizLocationEl = document.getElementById("bizLocation");
const bizMetaEl     = document.getElementById("bizMeta");

const loadingEl     = document.getElementById("loading");
const wrapEl        = document.getElementById("bookingWrap");

const serviceSelect  = document.getElementById("serviceSelect");
const employeeSelect = document.getElementById("employeeSelect");
const dateInput      = document.getElementById("dateInput");
const timeSelect     = document.getElementById("timeSelect");
const errorBox       = document.getElementById("errorBox");
const createBtn      = document.getElementById("createBtn");

const dayKeyMap = {
  1:"monday", 2:"tuesday", 3:"wednesday",
  4:"thursday", 5:"friday", 6:"saturday", 0:"Sunday"
};

let businessData = null;
let serviceDuration = 0;

/* ------------------- AUTH ------------------- */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="/al/customer-login.html?redirect="+location.href;
    return;
  }
  await loadBusiness();
});

/* ------------------- BUSINESS ------------------- */
async function loadBusiness(){
  const snap = await getDoc(doc(db,"businesses",businessId));
  if(!snap.exists()){
    loadingEl.textContent="İşletme bulunamadı.";
    return;
  }

  businessData = snap.data();

  bizLogoEl.src = businessData.logoBase64 || DEFAULT_BIZ_LOGO;
  bizNameEl.textContent = businessData.name;
  bizLocationEl.textContent = `${businessData.city || ""} ${businessData.district || ""}`;
  bizMetaEl.textContent = businessData.phone || "";
  document.getElementById("bizAddress").textContent =
  businessData.address ? `Adres: ${businessData.address}` : "";

document.getElementById("bizDesc").textContent =
  businessData.description ? `Açıklama: ${businessData.description}` : "";
  

  loadingEl.style.display="none";
  wrapEl.style.display="block";

  setDateMin();
  loadServices();
}

function setDateMin(){
  const t=new Date();
  dateInput.min=t.toISOString().substring(0,10);
}

/* ------------------- SERVICES ------------------- */
async function loadServices(){
  const qRef = query(
    collection(db,"services"),
    where("businessID","==",businessId)
  );

  const snap = await getDocs(qRef);

  serviceSelect.innerHTML="<option value=''>Hizmet seçin</option>";

  snap.forEach(s=>{
    const d=s.data();
    const opt=document.createElement("option");
    opt.value=s.id;
    opt.textContent=`${d.name} (${d.duration} dk)`;
    opt.dataset.name = d.name;
    opt.dataset.duration=d.duration;
    serviceSelect.appendChild(opt);
  });

  serviceSelect.onchange = ()=>{
    employeeSelect.innerHTML="<option>Yükleniyor...</option>";
    serviceDuration = parseInt(serviceSelect.selectedOptions[0].dataset.duration);
    loadEmployees(serviceSelect.value);
    timeSelect.innerHTML="";
  };

  dateInput.onchange = fillTimes;
}

/* ------------------- EMPLOYEES ------------------- */
async function loadEmployees(serviceId){
  const qRef = query(
    collection(db,"employees"),
    where("businessID","==",businessId)
  );

  const snap = await getDocs(qRef);

  employeeSelect.innerHTML="<option value=''>Çalışan seçin</option>";

  snap.forEach(e=>{
    const d=e.data();
    if(d.services.includes(serviceId)){
      const opt=document.createElement("option");
      opt.value=e.id;
      opt.textContent=d.name;
      opt.dataset.name = d.name;
      employeeSelect.appendChild(opt);
    }
  });

  employeeSelect.onchange = fillTimes;
}

/* ------------------- SLOT ------------------- */
function generateSlots(start,end,duration){
  let slots=[];
  let cur=new Date("2000-01-01 "+start);
  let close=new Date("2000-01-01 "+end);

  while(cur<=close){
    let endTime=new Date(cur.getTime()+duration*60000);

    if(endTime<=close){
      const H=String(cur.getHours()).padStart(2,"0");
      const M=String(cur.getMinutes()).padStart(2,"0");
      slots.push(`${H}:${M}`);
    }

    cur=new Date(cur.getTime()+30*60000);
  }
  return slots;
}

/* ------------------- TIMES ------------------- */
async function fillTimes(){

  timeSelect.innerHTML="";

  if(!dateInput.value || !employeeSelect.value || !serviceSelect.value)
    return;

  const day=new Date(dateInput.value).getDay();
  const key=dayKeyMap[day];

  const schedule=businessData.schedule || {};
  if(!schedule[key] || schedule[key].closed){
    timeSelect.innerHTML="<option>Bu gün kapalı</option>";
    return;
  }

  const start=schedule[key].start;
  const end  =schedule[key].end;

  const possibleSlots = generateSlots(start,end,serviceDuration);

  const qRef=query(
    collection(db,"appointments"),
    where("businessID","==",businessId),
    where("date","==",dateInput.value),
    where("employeeID","==",employeeSelect.value)
  );

  const snap = await getDocs(qRef);
  const booked = snap.docs.map(x=>x.data().time);

  possibleSlots.forEach(s=>{
    if(!booked.includes(s)){
      const o=document.createElement("option");
      o.value=s;
      o.textContent=s;
      timeSelect.appendChild(o);
    }
  });

  if(timeSelect.innerHTML===""){
    timeSelect.innerHTML="<option>Tüm saatler dolu</option>";
  }
}
/* ------------------- RANDEVU OLUŞTURMA ------------------- */
createBtn.onclick = async()=>{

  const serviceName   = serviceSelect.selectedOptions[0]?.dataset.name || "";
  const employeeName  = employeeSelect.selectedOptions[0]?.dataset.name || "";

  if(!serviceSelect.value || !employeeSelect.value || !dateInput.value || !timeSelect.value){
    errorBox.style.display="block";
    errorBox.textContent="Tüm alanları doldurun.";
    return;
  }

  createBtn.disabled=true;
  createBtn.textContent="Oluşturuluyor...";

  try{

    /* -------- MÜŞTERİ PROFİLİ ALINIYOR -------- */
    const customerSnap = await getDoc(doc(db,"customers", auth.currentUser.uid));
    const customerData = customerSnap.exists() ? customerSnap.data() : {
      name: "",
      phone: "",
      photo: ""
    };

    const customerName  = customerData.name  || "";
    const customerPhone = customerData.phone || "";
    const customerPhoto = customerData.photo || "";

    /* -------- RANDEVU KAYDI -------- */
    await addDoc(collection(db,"appointments"),{

      /* --- İşletme --- */
      businessID: businessId,
      businessName: businessData.name,
      businessLogo: businessData.logoBase64 || DEFAULT_BIZ_LOGO,

      /* --- Hizmet --- */
      serviceID: serviceSelect.value,
      serviceName: serviceName,

      /* --- Çalışan --- */
      employeeID: employeeSelect.value,
      employeeName: employeeName,

      /* --- Müşteri --- */
      customerUID: auth.currentUser.uid,
      customerName: customerName,
      customerPhone: customerPhone,
      customerPhoto: customerPhoto,

      /* --- Zaman --- */
      date: dateInput.value,
      time: timeSelect.value,
      duration: serviceDuration,

      /* --- Sistem --- */
      status: "pending",     // Ajanda’da "Beklemede" olarak gösteriliyor
      statusLabel: "Beklemede",
      createdAt: Date.now()
    });

    alert("Randevu oluşturuldu!");
    window.location.href = "/al/customer-panel.html";

  } catch(err){
    errorBox.style.display="block";
    errorBox.textContent="Randevu oluşturulamadı.";
    console.error(err);
  }

  createBtn.disabled=false;
  createBtn.textContent="Randevuyu Oluştur";
};

</script>

</body>
</html>
