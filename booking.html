<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Randevu Oluştur | Cepterandevu</title>

<style>
:root{
  --bg:#050816;
  --card:#0f172a;
  --accent:#22c55e;
  --accent-soft:rgba(34,197,94,0.15);
  --text:#f1f5f9;
  --muted:#94a3b8;
  --radius:16px;
  --border:rgba(148,163,184,0.18);
}
*{box-sizing:border-box;margin:0;padding:0;}

body{
  margin:0;
  background:radial-gradient(circle at top,#111827,#020617 55%);
  color:var(--text);
  font-family:system-ui;
  padding:16px;
  min-height:100vh;
  display:flex;
  justify-content:center;
}

.container{width:100%;max-width:960px;}

.top-bar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:16px;
}
.logo-group{display:flex;align-items:center;gap:10px;}
.logo-mark{
  width:32px;height:32px;border-radius:14px;
  background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
  display:flex;align-items:center;justify-content:center;
  color:#ecfdf5;font-weight:800;font-size:18px;
}
.logo-text-main{font-weight:700;font-size:16px;}
.logo-text-sub{font-size:11px;color:var(--muted);}

.biz-logo-box{
  width:86px;height:86px;border-radius:14px;background:#020617;
  border:1px solid rgba(148,163,184,0.35);
  margin-bottom:10px;display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.biz-logo-box img{width:100%;height:100%;object-fit:contain;}

.card-grid{
  display:grid;gap:16px;
  grid-template-columns:minmax(0,1.05fr) minmax(0,1fr);
}

.card{
  background:var(--card);padding:18px;border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:0 18px 45px rgba(15,23,42,0.85);
}

h2{font-size:20px;margin-bottom:8px;}

.biz-name{font-size:18px;font-weight:600;}
.biz-location{font-size:13px;color:var(--muted);margin-bottom:8px;}
.biz-meta{font-size:12px;color:var(--muted);}

label{font-size:13px;color:var(--muted);margin-bottom:4px;display:block;}
select,input{
  width:100%;padding:10px;border-radius:var(--radius);
  border:1px solid rgba(255,255,255,0.15);background:#020617;
  color:var(--text);margin-bottom:12px;font-size:14px;
}
select:focus,input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 1px var(--accent);
}

.btn-primary{
  width:100%;padding:12px;border-radius:var(--radius);border:0;
  background:linear-gradient(135deg,var(--accent),#16a34a);
  color:#022c22;font-weight:600;font-size:15px;
}
.error-box{
  background:rgba(239,68,68,0.15);
  border:1px solid rgba(239,68,68,0.45);
  color:#fecaca;padding:8px;border-radius:12px;
  font-size:12px;margin-bottom:10px;display:none;
}

@media(max-width:768px){
  .card-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<div class="container">

  <div class="top-bar">
    <div class="logo-group">
      <div class="logo-mark">C</div>
      <div>
        <div class="logo-text-main">Cepterandevu</div>
        <div class="logo-text-sub">Randevunu birkaç adımda tamamla</div>
      </div>
    </div>
  </div>

  <div id="loading" class="card">İşletme bilgileri yükleniyor...</div>

  <div id="bookingWrap" class="card-grid" style="display:none;">
    
    <!-- SOL BİLGİ KISMI -->
    <section class="card">
      <h2>İşletme Bilgisi</h2>

      <div class="biz-logo-box"><img id="bizLogo"></div>

      <div class="biz-name" id="bizName"></div>
      <div class="biz-location" id="bizLocation"></div>
      <div class="biz-meta" id="bizMeta"></div>

      <div id="slotInfo" class="info-box" style="margin-top:10px;display:none;"></div>
    </section>

    <!-- SAĞ FORM -->
    <section class="card">
      <h2>Randevu Oluştur</h2>

      <div id="errorBox" class="error-box"></div>

      <label>Hizmet Seç</label>
      <select id="serviceSelect"><option>Yükleniyor...</option></select>

      <label>Çalışan Seç</label>
      <select id="employeeSelect"><option>Önce hizmet seçin</option></select>

      <label>Tarih</label>
      <input type="date" id="dateInput">

      <label>Saat</label>
      <select id="timeSelect"></select>

      <button id="createBtn" class="btn-primary">Randevuyu Oluştur</button>
    </section>

  </div>

</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc,
  collection, query, where, getDocs, addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ------------------ DEFAULT LOGO ------------------ */
const DEFAULT_BIZ_LOGO =
'data:image/svg+xml;utf8,' +
'<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 256 256">' +
'<rect width="256" height="256" fill="%23020a1b"/>' +
'<rect x="28" y="28" width="200" height="200" rx="36" fill="none" stroke="%2322c55e" stroke-width="4"/>' +
'<text x="50%" y="52%" text-anchor="middle" dominant-baseline="middle"' +
' font-family="system-ui" font-size="38" fill="%2322c55e">C</text>' +
'</svg>';

/* ------------------ FIREBASE ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
  authDomain: "cepterandevu-35fe4.firebaseapp.com",
  projectId: "cepterandevu-35fe4",
  storageBucket: "cepterandevu-35fe4.firebasestorage.app",
  messagingSenderId: "86298180836",
  appId: "1:86298180836:web:124c2004605d68b32700f1",
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth= getAuth(app);

/* ------------------ DOM ------------------ */
const businessId = new URLSearchParams(location.search).get("businessId");

const bizLogoEl = document.getElementById("bizLogo");
const bizNameEl = document.getElementById("bizName");
const bizLocationEl = document.getElementById("bizLocation");
const bizMetaEl = document.getElementById("bizMeta");

const loadingEl = document.getElementById("loading");
const bookingWrap= document.getElementById("bookingWrap");

const serviceSelect  = document.getElementById("serviceSelect");
const employeeSelect = document.getElementById("employeeSelect");
const dateInput      = document.getElementById("dateInput");
const timeSelect     = document.getElementById("timeSelect");
const errorBox       = document.getElementById("errorBox");
const createBtn      = document.getElementById("createBtn");

/* ------------------ DAY KEY MAP ------------------ */
const dayKeyMap = {
  1:"monday", 2:"tuesday", 3:"wednesday",
  4:"thursday", 5:"friday", 6:"saturday", 0:"sunday"
};

let businessData = null;
let currentUser = null;

/* ------------------ AUTH ------------------ */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href = "/al/customer-login.html?redirect=" + encodeURIComponent(location.href);
    return;
  }
  currentUser = user;
  await loadBusiness();
});

/* ------------------ BUSINESS ------------------ */
async function loadBusiness(){
  const ref = doc(db,"businesses",businessId);
  const snap= await getDoc(ref);

  if(!snap.exists()){
    loadingEl.textContent="İşletme bulunamadı.";
    return;
  }

  businessData = snap.data();

  bizLogoEl.src = businessData.logoBase64 || DEFAULT_BIZ_LOGO;
  bizNameEl.textContent = businessData.name || "İşletme";
  bizLocationEl.textContent = `${businessData.city||""}${businessData.district?" · "+businessData.district:""}`;
  bizMetaEl.textContent = businessData.phone || "";

  loadingEl.style.display="none";
  bookingWrap.style.display="grid";

  setDateLimit();
  await loadServices();
}

/* ------------------ DATE MIN ------------------ */
function setDateLimit(){
  const t = new Date();
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,"0");
  const d = String(t.getDate()).padStart(2,"0");
  dateInput.min = `${y}-${m}-${d}`;
}

/* ------------------ SERVICES ------------------ */
async function loadServices(){
  const qRef = query(
    collection(db,"services"),
    where("businessID","==",businessId)
  );
  const snap = await getDocs(qRef);

  serviceSelect.innerHTML = "<option value=''>Hizmet seçin</option>";

  snap.forEach(s=>{
    const d = s.data();
    const opt=document.createElement("option");
    opt.value=s.id;
    opt.textContent=`${d.name} (${d.duration} dk)`;
    serviceSelect.appendChild(opt);
  });

  serviceSelect.addEventListener("change",()=>{
    loadEmployees(serviceSelect.value);
    timeSelect.innerHTML="";
  });

  dateInput.addEventListener("change", fillTimes);
}

/* ------------------ EMPLOYEES ------------------ */
async function loadEmployees(serviceId){
  employeeSelect.innerHTML="<option>Yükleniyor...</option>";

  if(!serviceId){
    employeeSelect.innerHTML="<option>Önce hizmet seçin</option>";
    return;
  }

  const qRef = query(
    collection(db,"employees"),
    where("businessID","==",businessId)
  );
  const snap = await getDocs(qRef);

  employeeSelect.innerHTML="<option value=''>Çalışan seçin</option>";

  snap.forEach(e=>{
    const d=e.data();
    if(Array.isArray(d.services)&&d.services.includes(serviceId)){
      const opt=document.createElement("option");
      opt.value=e.id;
      opt.textContent=d.name;
      employeeSelect.appendChild(opt);
    }
  });

  employeeSelect.addEventListener("change", fillTimes);
}

/* ------------------ HOURS FROM SCHEDULE ------------------ */
function generateHours(start,end){
  const s = parseInt(start.split(":")[0]);
  const e = parseInt(end.split(":")[0]);
  const arr=[];
  for(let h=s;h<=e;h++){
    arr.push(String(h).padStart(2,"0")+":00");
    arr.push(String(h).padStart(2,"0")+":30");
  }
  return arr;
}

/* ------------------ FILL TIMES ------------------ */
async function fillTimes(){
  timeSelect.innerHTML="";

  if(!dateInput.value || !employeeSelect.value || !serviceSelect.value){
    return;
  }

  const day = new Date(dateInput.value).getDay();
  const key = dayKeyMap[day];

  const schedule = businessData.schedule || {};

  if(!schedule[key] || schedule[key].closed){
    timeSelect.innerHTML="<option>Bu gün kapalı</option>";
    return;
  }

  const start=schedule[key].start;
  const end  =schedule[key].end;

  const hours = generateHours(start,end);
  if(hours.length===0){
    timeSelect.innerHTML="<option>Saat bulunamadı</option>";
    return;
  }

  hours.forEach(h=>{
    const opt=document.createElement("option");
    opt.value=h;
    opt.textContent=h;
    timeSelect.appendChild(opt);
  });
}

/* ------------------ CREATE APPOINTMENT ------------------ */
createBtn.addEventListener("click", async()=>{
  errorBox.style.display="none";

  if(!serviceSelect.value || !employeeSelect.value || !dateInput.value || !timeSelect.value){
    errorBox.textContent="Lütfen tüm alanları doldurun.";
    errorBox.style.display="block";
    return;
  }

  createBtn.disabled=true;
  createBtn.textContent="Oluşturuluyor...";

  try{
    await addDoc(collection(db,"appointments"),{
      businessID:businessId,
      serviceID:serviceSelect.value,
      employeeID:employeeSelect.value,
      customerUID:currentUser.uid,
      date:dateInput.value,
      time:timeSelect.value,
      status:"pending",
      createdAt:Date.now()
    });

    alert("Randevu talebiniz oluşturuldu.");

  }catch(err){
    console.error(err);
    errorBox.textContent="Randevu oluşturulamadı.";
    errorBox.style.display="block";

  }finally{
    createBtn.disabled=false;
    createBtn.textContent="Randevuyu Oluştur";
  }
});
</script>

</body>
</html>
