<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Randevu Oluştur</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --text:#f1f5f9;
      --muted:#94a3b8;
      --radius:16px;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui, sans-serif;
      padding:16px;
    }

    .container{
      max-width:500px;
      margin:0 auto;
    }

    .card{
      background:var(--card);
      padding:16px;
      margin-bottom:14px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.08);
    }

    h2{
      margin-top:0;
      font-size:18px;
    }

    label{
      font-size:14px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }

    select, input{
      width:100%;
      padding:10px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.15);
      background:#0b1120;
      color:var(--text);
      margin-bottom:12px;
      font-size:15px;
    }

    button{
      width:100%;
      padding:12px;
      border:0;
      border-radius:var(--radius);
      background:var(--accent);
      color:#022c22;
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }

    button:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }

    .loading{
      text-align:center;
      padding:20px;
      color:var(--muted);
    }

  </style>
</head>
<body>

<div class="container">

  <div id="loading" class="loading">İşletme bilgileri yükleniyor...</div>

  <div id="bookingCard" class="card" style="display:none;">
    <h2 id="bizName">İşletme</h2>
    <p id="bizLocation" style="color:var(--muted);font-size:14px;"></p>

    <label>Hizmet Seç</label>
    <select id="serviceSelect"></select>

    <label>Çalışan Seç</label>
    <select id="employeeSelect"></select>

    <label>Tarih</label>
    <input type="date" id="dateInput">

    <label>Saat</label>
    <select id="timeSelect"></select>

    <button id="createBtn">Randevuyu Oluştur</button>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc,
    collection, query, where, getDocs, addDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // kendi config'inle değiştir
  const firebaseConfig = {
  apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
  authDomain: "cepterandevu-35fe4.firebaseapp.com",
  projectId: "cepterandevu-35fe4",
  storageBucket: "cepterandevu-35fe4.firebasestorage.app",
  messagingSenderId: "86298180836",
  appId: "1:86298180836:web:124c2004605d68b32700f1",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const businessId = urlParams.get("businessId");

  const bizNameEl = document.getElementById("bizName");
  const bizLocationEl = document.getElementById("bizLocation");
  const serviceSelect = document.getElementById("serviceSelect");
  const employeeSelect = document.getElementById("employeeSelect");
  const dateInput = document.getElementById("dateInput");
  const timeSelect = document.getElementById("timeSelect");
  const createBtn = document.getElementById("createBtn");
  const loadingEl = document.getElementById("loading");
  const cardEl = document.getElementById("bookingCard");

  // sabit örnek saatler
  const hours = [
    "09:00","09:30","10:00","10:30",
    "11:00","11:30","13:00","13:30",
    "14:00","14:30","15:00","15:30",
    "16:00","16:30","17:00"
  ];

  hours.forEach(h=>{
    const opt=document.createElement("option");
    opt.value=h;
    opt.textContent=h;
    timeSelect.appendChild(opt);
  });

  async function loadBusiness(){
    if(!businessId){
      loadingEl.textContent = "businessId bulunamadı.";
      return;
    }

    const ref = doc(db,"businesses",businessId);
    const snap = await getDoc(ref);

    if(!snap.exists()){
      loadingEl.textContent = "İşletme bulunamadı.";
      return;
    }

    const biz = snap.data();

    bizNameEl.textContent = biz.name;
    bizLocationEl.textContent = `${biz.city} - ${biz.district}`;

    cardEl.style.display="block";
    loadingEl.style.display="none";

    await loadServices();
  }

  async function loadServices(){
    serviceSelect.innerHTML = "<option value=''>Hizmet seçin</option>";

    const q = query(collection(db,"services"), where("businessID","==",businessId));
    const snap = await getDocs(q);

    snap.forEach(docSnap=>{
      const s = docSnap.data();
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.textContent = `${s.name} (${s.duration} dk)`;
      serviceSelect.appendChild(opt);
    });
  }

  async function loadEmployees(serviceId){
    employeeSelect.innerHTML = "<option value=''>Çalışan seçin</option>";

    if(!serviceId) return;

    const q = query(collection(db,"employees"), where("businessID","==",businessId));
    const snap = await getDocs(q);

    snap.forEach(docSnap=>{
      const emp = docSnap.data();
      if(emp.services.includes(serviceId)){
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = emp.name;
        employeeSelect.appendChild(opt);
      }
    });
  }

  serviceSelect.addEventListener("change", ()=>{
    loadEmployees(serviceSelect.value);
  });

  createBtn.addEventListener("click", async ()=>{
    const serviceId = serviceSelect.value;
    const empId = employeeSelect.value;
    const date = dateInput.value;
    const time = timeSelect.value;

    if(!serviceId || !empId || !date || !time){
      alert("Tüm alanları seçmelisin.");
      return;
    }

    createBtn.disabled = true;

    await addDoc(collection(db,"appointments"), {
      businessID: businessId,
      serviceID: serviceId,
      employeeID: empId,
      customerUID: "anonim-test", // login ekleyince değişecek
      date: date,
      time: time,
      status: "pending",
      createdAt: Date.now()
    });

    alert("Randevu oluşturuldu!");
    createBtn.disabled = false;
  });

  loadBusiness();
</script>
</body>
</html>
