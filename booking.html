<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Randevu Oluştur | Cepterandevu</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --text:#f1f5f9;
      --muted:#94a3b8;
      --radius:16px;
      --border:rgba(148,163,184,0.18);
    }
    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      margin:0;
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--text);
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      padding:16px;
      min-height:100vh;
      display:flex;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:960px;
    }

    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .logo-group{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-mark{
      width:32px;
      height:32px;
      border-radius:14px;
      background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ecfdf5;
      font-weight:800;
      font-size:18px;
      box-shadow:0 10px 30px rgba(34,197,94,0.6);
    }
    .logo-text-main{
      font-weight:700;
      letter-spacing:0.03em;
      font-size:16px;
    }
    .logo-text-sub{
      font-size:11px;
      color:var(--muted);
    }

    .biz-logo-box{
      width:86px;
      height:86px;
      border-radius:14px;
      background:#020617;
      border:1px solid rgba(148,163,184,0.35);
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .biz-logo-box img{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    .card-grid{
      display:grid;
      grid-template-columns:minmax(0,1.05fr) minmax(0,1fr);
      gap:16px;
    }

    .card{
      background:var(--card);
      padding:18px;
      margin-bottom:14px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:0 18px 45px rgba(15,23,42,0.85);
    }

    h2{
      margin-top:0;
      font-size:20px;
      margin-bottom:8px;
    }

    .biz-name{
      font-size:18px;
      font-weight:600;
    }
    .biz-location{
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .biz-meta{
      font-size:12px;
      color:var(--muted);
    }

    label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }
    select, input{
      width:100%;
      padding:10px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.15);
      background:#020617;
      color:var(--text);
      margin-bottom:12px;
      font-size:14px;
      outline:none;
    }

    .btn-primary{
      width:100%;
      padding:12px;
      border:0;
      border-radius:var(--radius);
      background:linear-gradient(135deg,var(--accent),#16a34a);
      color:#022c22;
      font-weight:600;
      font-size:15px;
      cursor:pointer;
      margin-top:6px;
      box-shadow:0 12px 30px rgba(34,197,94,0.35);
    }

    .info-box{
      background:rgba(148,163,184,0.12);
      border:1px solid rgba(148,163,184,0.4);
      color:var(--muted);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      margin-bottom:10px;
    }

    .error-box{
      background:rgba(239,68,68,0.12);
      border:1px solid rgba(239,68,68,0.5);
      color:#fecaca;
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      margin-bottom:10px;
      display:none;
    }

    @media (max-width:768px){
      .card-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">

  <div class="top-bar">
    <div class="logo-group">
      <div class="logo-mark">C</div>
      <div>
        <div class="logo-text-main">Cepterandevu</div>
        <div class="logo-text-sub">Randevunu birkaç adımda tamamla</div>
      </div>
    </div>
  </div>

  <div id="loading" class="card">İşletme bilgileri yükleniyor...</div>

  <div id="bookingWrap" class="card-grid" style="display:none;">

    <section class="card">
      <h2>İşletme Bilgisi</h2>

      <div class="biz-logo-box"><img id="bizLogo" src=""></div>

      <div class="biz-name" id="bizName">İşletme</div>
      <div class="biz-location" id="bizLocation"></div>
      <div class="biz-meta" id="bizMeta"></div>

      <div id="bizHint" class="info-box">Hizmet ve çalışan seçerek randevu oluşturabilirsiniz.</div>
      <div id="slotInfo" class="info-box" style="display:none;"></div>
    </section>

    <section class="card">
      <h2>Randevu Oluştur</h2>

      <div id="errorBox" class="error-box"></div>

      <label>Hizmet Seç</label>
      <select id="serviceSelect"></select>

      <label>Çalışan Seç</label>
      <select id="employeeSelect"></select>

      <label>Tarih</label>
      <input type="date" id="dateInput">

      <label>Saat</label>
      <select id="timeSelect"></select>

      <button id="createBtn" class="btn-primary">Randevuyu Oluştur</button>
    </section>

  </div>
</div>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
  authDomain: "cepterandevu-35fe4.firebaseapp.com",
  projectId: "cepterandevu-35fe4",
  storageBucket: "cepterandevu-35fe4.firebasestorage.app",
  messagingSenderId: "86298180836",
  appId: "1:86298180836:web:124c2004605d68b32700f1"
};

const app   = initializeApp(firebaseConfig);
const db    = getFirestore(app);
const auth  = getAuth(app);

const businessId = new URLSearchParams(location.search).get("businessId");

let BUSINESS = null;

const bizLogoEl = document.getElementById("bizLogo");
const bizNameEl = document.getElementById("bizName");
const bizLocationEl = document.getElementById("bizLocation");
const bizMetaEl = document.getElementById("bizMeta");

const loadingEl = document.getElementById("loading");
const bookingWrap = document.getElementById("bookingWrap");

const serviceSelect = document.getElementById("serviceSelect");
const employeeSelect = document.getElementById("employeeSelect");
const dateInput = document.getElementById("dateInput");
const timeSelect = document.getElementById("timeSelect");
const errorBox = document.getElementById("errorBox");
const createBtn = document.getElementById("createBtn");

/* -------------------------------------------------------
   DAY MAP
------------------------------------------------------- */
function getDayName(dateStr){
  const d = new Date(dateStr);
  return [
    "sunday","monday","tuesday","wednesday",
    "thursday","friday","saturday"
  ][d.getDay()];
}

/* -------------------------------------------------------
   SLOT ÜRETİCİ
------------------------------------------------------- */
function generateSlots(start, end){
  let [sh, sm] = start.split(":").map(Number);
  let [eh, em] = end.split(":").map(Number);

  let now = sh*60 + sm;
  const finish = eh*60 + em;

  const list = [];
  while(now < finish){
    const h = String(Math.floor(now/60)).padStart(2,"0");
    const m = String(now%60).padStart(2,"0");
    list.push(`${h}:${m}`);
    now += 30;
  }
  return list;
}

/* -------------------------------------------------------
   ERROR Helpers
------------------------------------------------------- */
function showError(msg){
  errorBox.style.display = "block";
  errorBox.textContent = msg;
}
function clearError(){
  errorBox.style.display = "none";
}

/* -------------------------------------------------------
   CHECK SLOT AVAILABILITY
------------------------------------------------------- */
async function isSlotBusy(businessID, employeeID, date, time){
  const qRef = query(
    collection(db,"appointments"),
    where("businessID","==",businessID),
    where("employeeID","==",employeeID),
    where("date","==",date),
    where("time","==",time)
  );
  const snap = await getDocs(qRef);
  let busy = false;
  snap.forEach(d=>{
    if(["pending","approved"].includes(d.data().status)) busy = true;
  });
  return busy;
}

/* -------------------------------------------------------
   LOAD BUSINESS
------------------------------------------------------- */
async function loadBusiness(){
  const ref = doc(db,"businesses",businessId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    loadingEl.textContent = "İşletme bulunamadı.";
    return;
  }

  BUSINESS = snap.data();

  bizLogoEl.src = BUSINESS.logoBase64 || "";
  bizNameEl.textContent = BUSINESS.name || "İşletme";
  bizLocationEl.textContent = `${BUSINESS.city} · ${BUSINESS.district}`;
  bizMetaEl.textContent = BUSINESS.phone || "";

  loadingEl.style.display = "none";
  bookingWrap.style.display = "grid";

  await loadServices();
}

/* -------------------------------------------------------
   SERVICES
------------------------------------------------------- */
async function loadServices(){
  const qRef = query(
    collection(db,"services"),
    where("businessID","==",businessId)
  );
  const snap = await getDocs(qRef);

  serviceSelect.innerHTML = "<option value=''>Hizmet seç</option>";

  snap.forEach(s=>{
    const d = s.data();
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${d.name} (${d.duration} dk)`;
    serviceSelect.appendChild(opt);
  });

  serviceSelect.addEventListener("change",()=> loadEmployees(serviceSelect.value));
}

/* -------------------------------------------------------
   EMPLOYEES
------------------------------------------------------- */
async function loadEmployees(serviceId){
  const qRef = query(
    collection(db,"employees"),
    where("businessID","==",businessId)
  );
  const snap = await getDocs(qRef);

  employeeSelect.innerHTML = "<option value=''>Çalışan seç</option>";

  snap.forEach(e=>{
    const d = e.data();
    if(d.services?.includes(serviceId)){
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = d.name;
      employeeSelect.appendChild(opt);
    }
  });
}

/* -------------------------------------------------------
   DATE → SLOT UPDATE
------------------------------------------------------- */
dateInput.addEventListener("change", ()=> updateSlots());
employeeSelect.addEventListener("change", ()=> updateSlots());
serviceSelect.addEventListener("change", ()=> updateSlots());

async function updateSlots(){
  clearError();
  timeSelect.innerHTML = "";

  const date = dateInput.value;
  const emp  = employeeSelect.value;
  if(!date || !emp) return;

  const day = getDayName(date);
  const todaysSchedule = BUSINESS.schedule?.[day];

  if(!todaysSchedule || todaysSchedule.closed){
    timeSelect.innerHTML = "<option>Bu gün kapalı</option>";
    timeSelect.disabled = true;
    return;
  }

  const slots = generateSlots(
    todaysSchedule.start,
    todaysSchedule.end
  );

  timeSelect.disabled = false;
  timeSelect.innerHTML = "";

  for(const s of slots){
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    timeSelect.appendChild(opt);
  }
}

/* -------------------------------------------------------
   ON CREATE APPOINTMENT
------------------------------------------------------- */
createBtn.addEventListener("click", async ()=>{
  clearError();

  const serviceId = serviceSelect.value;
  const employeeId = employeeSelect.value;
  const date = dateInput.value;
  const time = timeSelect.value;

  if(!serviceId || !employeeId || !date || !time){
    showError("Lütfen tüm alanları doldurun.");
    return;
  }

  const busy = await isSlotBusy(businessId, employeeId, date, time);
  if(busy){
    showError("Bu saat dolu. Lütfen başka bir saat seçin.");
    return;
  }

  await addDoc(collection(db,"appointments"),{
    businessID: businessId,
    serviceID: serviceId,
    employeeID: employeeId,
    date,
    time,
    status:"pending",
    createdAt: Date.now()
  });

  alert("Randevu talebi oluşturuldu.");
  location.reload();
});

/* -------------------------------------------------------
   AUTH & START
------------------------------------------------------- */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href = "/al/customer-login.html";
    return;
  }
  loadBusiness();
});

</script>
