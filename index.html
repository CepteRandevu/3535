<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Randeo</title>

<style>
  body {
    margin: 0;
    background: #f2f4f7;
    font-family: "Segoe UI", sans-serif;
  }

  .navbar {
    position: sticky;
    top: 0;
    background: white;
    padding: 14px 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
  }

  .navbar h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: #222;
  }

  .btn-login {
    padding: 10px 16px;
    background: #007bff;
    color: white;
    border-radius: 10px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
  }

  .container {
    padding: 20px;
    max-width: 500px;
    margin: auto;
  }

  .title {
    font-size: 20px;
    margin-bottom: 18px;
    font-weight: 600;
    color: #1e293b;
  }

  select, input {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    margin-bottom: 12px;
    background: white;
    font-size: 16px;
  }

  .business-card {
    background: white;
    margin-top: 14px;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 3px 14px rgba(0,0,0,0.10);
    cursor: pointer;
    transition: 0.2s;
  }

  .business-card:hover {
    transform: scale(1.01);
  }

  .empty {
    margin-top: 20px;
    background: white;
    padding: 16px;
    border-radius: 14px;
    text-align: center;
    color: #6b7280;
  }
</style>
</head>

<body>

<div class="navbar">
  <h1>Randeo</h1>
  <div>
    <a class="btn-login" href="/al/pages/business/business-auth.html">İşletme Girişi</a>
    <a class="btn-login" style="margin-left:8px;background:#111827;" href="/al/pages/user/user-login.html">Müşteri Girişi</a>
  </div>
</div>

<div class="container">
  <div class="title">Bölge Seç → İşletmeleri Gör</div>

  <select id="city">
    <option value="">İl seçiniz</option>
  </select>

  <select id="district">
    <option value="">Önce il seçiniz</option>
  </select>

  <div id="businessList"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, query, where
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8jn673zFuYRDhgzFd5yfZ-MP2XSXgyFg",
    authDomain: "cepterandevu-35fe4.firebaseapp.com",
    projectId: "cepterandevu-35fe4",
    storageBucket: "cepterandevu-35fe4.appspot.com",
    messagingSenderId: "86298180836",
    appId: "1:86298180836:web:ab05fbb0dcfbb56b2700f1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const citySelect = document.getElementById("city");
  const districtSelect = document.getElementById("district");
  const list = document.getElementById("businessList");

  let allBusinesses = [];

  // ----------------------------------------------------
  // 1) TÜM İŞLETMELERİ TEK SEFERDE ÇEK
  // ----------------------------------------------------
  async function loadAll() {
    const snap = await getDocs(collection(db, "businesses"));
    allBusinesses = snap.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    loadCities();
  }

  // ----------------------------------------------------
  // 2) ŞEHİR LİSTESİ OLUŞTUR
  // ----------------------------------------------------
  function loadCities() {
    const cities = [...new Set(allBusinesses.map(b => b.city))];

    citySelect.innerHTML = `<option value="">İl seçiniz</option>`;
    cities.forEach(c => {
      citySelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
  }

  // ----------------------------------------------------
  // 3) İL DEĞİŞİNCE İLÇELERİ ÇEK
  // ----------------------------------------------------
  citySelect.addEventListener("change", () => {
    const city = citySelect.value;

    districtSelect.innerHTML = `<option value="">İlçe seçiniz</option>`;

    if (!city) {
      list.innerHTML = "";
      return;
    }

    const districts = [
      ...new Set(
        allBusinesses
          .filter(b => b.city === city)
          .map(b => b.district)
      )
    ];

    districts.forEach(d => {
      districtSelect.innerHTML += `<option value="${d}">${d}</option>`;
    });

    list.innerHTML = "";
  });

  // ----------------------------------------------------
  // 4) İLÇE DEĞİŞİNCE İŞLETMELERİ LİSTELE
  // ----------------------------------------------------
  districtSelect.addEventListener("change", () => {
    const city = citySelect.value;
    const district = districtSelect.value;

    list.innerHTML = "";

    if (!city || !district) return;

    const filtered = allBusinesses.filter(
      b => b.city === city && b.district === district
    );

    if (!filtered.length) {
      list.innerHTML = `<div class="empty">Bu bölgede işletme yok.</div>`;
      return;
    }

    filtered.forEach(b => {
      list.innerHTML += `
        <div class="business-card" onclick="location.href='/al/pages/detail.html?id=${b.id}'">
          <b>${b.name}</b><br>
          <small>${b.city} / ${b.district}</small>
        </div>
      `;
    });
  });

  // BAŞLAT
  loadAll();
</script>

</body>
</html>
