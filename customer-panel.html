<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Müşteri Paneli | Cepterandevu</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --card-soft:#020617;
      --text:#f8fafc;
      --muted:#94a3b8;
      --accent:#22c55e;
      --accent-strong:#16a34a;
      --danger:#ef4444;
      --border:rgba(148,163,184,0.4);
      --radius-lg:18px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.85);
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px 12px 32px;
    }

    .app{
      width:100%;
      max-width:900px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .logo{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-mark{
      width:32px;height:32px;border-radius:14px;
      background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:800;color:#ecfdf5;
      box-shadow:0 10px 30px rgba(34,197,94,0.6);
    }
    .logo-text-main{font-weight:600;font-size:16px;}
    .logo-text-sub{font-size:11px;color:var(--muted);}

    .logout-btn{
      border:0;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;
      cursor:pointer;
      background:var(--danger);
      color:#fff;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.2fr);
      gap:16px;
    }

    @media(max-width:780px){
      .grid{grid-template-columns:minmax(0,1fr);}
    }

    .card{
      background:rgba(15,23,42,0.96);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 18px;
      margin-bottom:16px;
    }

    h2{
      font-size:18px;
      margin-bottom:10px;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }

    .profile-layout{
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    @media(max-width:560px){
      .profile-layout{flex-direction:column;align-items:flex-start;}
    }

    .pfp-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .pfp{
      width:84px;height:84px;
      border-radius:999px;
      object-fit:cover;
      border:2px solid var(--accent);
      background:#020617;
    }
    .pfp-btn{
      padding:6px 14px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-size:11px;
      font-weight:600;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;
      box-shadow:0 8px 18px rgba(34,197,94,0.35);
    }

    .profile-info-row{
      font-size:13px;
      margin-bottom:4px;
    }
    .profile-info-row span.label{
      color:var(--muted);
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:3px;
    }
    input{
      width:100%;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#020617;
      color:var(--text);
      font-size:13px;
      margin-bottom:10px;
      outline:none;
    }
    input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent);
    }

    .btn-primary{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;
      font-weight:600;
      font-size:14px;
      box-shadow:0 12px 28px rgba(34,197,94,0.4);
      margin-top:4px;
    }

    .btn-secondary{
      width:100%;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.45);
      cursor:pointer;
      background:#020617;
      color:var(--text);
      font-weight:500;
      font-size:13px;
      margin-top:4px;
    }

    .appt{
      background:var(--card-soft);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      padding:11px 11px 9px;
      margin-bottom:8px;
      font-size:12px;
    }

    .appt-title{
      font-weight:600;
      margin-bottom:4px;
    }

    .status{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      margin-top:5px;
    }
    .pending{background:rgba(234,179,8,0.2);color:#facc15;}
    .approved{background:rgba(34,197,94,0.2);color:#4ade80;}
    .rejected{background:rgba(239,68,68,0.2);color:#ef4444;}
    .cancelled{background:rgba(148,163,184,0.2);color:#e5e7eb;}

    .small-btn{
      padding:5px 10px;
      border-radius:10px;
      border:0;
      font-size:11px;
      cursor:pointer;
      background:var(--danger);
      color:#fff;
      margin-top:6px;
    }
  </style>

  <!-- OneSignal -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal){
        await OneSignal.init({
          appId:"784cba74-0683-49ed-a3c6-e86741fc6aee"
        });
      });
  </script>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="logo-mark">C</div>
      <div>
        <div class="logo-text-main">Cepterandevu</div>
        <div class="logo-text-sub">Müşteri Paneli</div>
      </div>
    </div>
    <button id="logoutBtn" class="logout-btn">Çıkış Yap</button>
  </header>

  <main class="grid">
    
    <!-- SOL TARAF -->
    <section>
      <div class="card">
        <h2>Profilim</h2>

        <div class="profile-layout">
          <div class="pfp-wrap">
            <img id="pfp" class="pfp">
            <button id="choosePhotoBtn" class="pfp-btn">Fotoğraf Seç</button>
            <input id="photoInput" type="file" accept="image/*" style="display:none;">
          </div>

          <div style="flex:1;">
            <div class="profile-info-row">
              <span class="label">Ad Soyad:</span> <span id="pName"></span>
            </div>
            <div class="profile-info-row">
              <span class="label">Telefon:</span> <span id="pPhone"></span>
            </div>
            <div class="profile-info-row">
              <span class="label">Üyelik:</span> <span id="pJoin"></span>
            </div>

            <label>Ad Soyad</label>
            <input id="editName">

            <label>Yeni Şifre</label>
            <input id="editPassword" type="password">

            <button id="saveProfileBtn" class="btn-primary">Profili Kaydet</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Hatırlatıcı (15 gün sonra)</h2>
        <button id="reminderBtn" class="btn-secondary">Hatırlatıcı Kur</button>
        <div id="reminderInfo" style="font-size:12px;margin-top:6px;color:#94a3b8;"></div>
      </div>
    </section>

    <!-- SAĞ TARAF -->
    <section>
      <div class="card">
        <h2>Yaklaşan Randevular</h2>
        <div id="upcomingList">Yükleniyor...</div>
      </div>

      <div class="card">
        <h2>Geçmiş Randevular</h2>
        <div id="historyList">Yükleniyor...</div>
      </div>
    </section>

  </main>
</div>

<script type="module">

/* --------------------------------------------------------------------
     FIREBASE IMPORT
-------------------------------------------------------------------- */
import { firebaseConfig } from "./js/firebase-config.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc,
  collection, query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, signOut, updatePassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* INIT */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let uid = null;

/* HTML ELEMANLARI */
const pfp = document.getElementById("pfp");
const pName = document.getElementById("pName");
const pPhone = document.getElementById("pPhone");
const pJoin = document.getElementById("pJoin");

const editName = document.getElementById("editName");
const editPassword = document.getElementById("editPassword");
const saveProfileBtn = document.getElementById("saveProfileBtn");

const upcomingList = document.getElementById("upcomingList");
const historyList = document.getElementById("historyList");

/* --------------------------------------------------------------------
     AUTH
-------------------------------------------------------------------- */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="customer-login.html";
    return;
  }

  uid = user.uid;
  loadProfile();
  listenAppointmentsRealtime();     // ANLIK TAKİP BURADA
  savePlayerID();                   // OneSignal kayıt
});

/* --------------------------------------------------------------------
     PROFİL YÜKLEME
-------------------------------------------------------------------- */
async function loadProfile(){
  const ref = doc(db,"customers",uid);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    pName.textContent="-";
    return;
  }

  const d = snap.data();
  pName.textContent = d.name;
  pPhone.textContent = d.phone;
  pJoin.textContent = d.createdAt?.toDate?.().toLocaleDateString("tr-TR") ?? "-";

  editName.value = d.name;

  if(d.photoURL){
    pfp.src = d.photoURL;
  }else{
    pfp.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  }
}

/* --------------------------------------------------------------------
     PROFİL FOTOĞRAF YÜKLEME
-------------------------------------------------------------------- */
choosePhotoBtn.onclick = ()=> photoInput.click();

photoInput.onchange = async()=>{
  const file = photoInput.files[0];
  if(!file) return;

  const r = ref(storage, "profilePics/"+uid+".jpg");
  await uploadBytes(r, file);
  const url = await getDownloadURL(r);

  await updateDoc(doc(db,"customers",uid), { photoURL:url });
  pfp.src = url;
};

/* --------------------------------------------------------------------
     PROFİL KAYDET
-------------------------------------------------------------------- */
saveProfileBtn.onclick = async()=>{
  await updateDoc(doc(db,"customers",uid), {
    name: editName.value.trim()
  });

  if(editPassword.value.length >= 6){
    await updatePassword(auth.currentUser, editPassword.value);
  }

  alert("Profil güncellendi.");
};

/* --------------------------------------------------------------------
     ANLIK RANDEVU TAKİBİ  (REALTIME)
-------------------------------------------------------------------- */
function listenAppointmentsRealtime(){
  const qRef = query(
    collection(db,"appointments"),
    where("customerUID","==", uid)
  );

  onSnapshot(qRef, async(snap)=>{
    const items = [];
    snap.forEach(d=> items.push({id:d.id, ...d.data()}));

    renderAppointments(items);
  });
}

function renderAppointments(list){
  const today = new Date();
  today.setHours(0,0,0,0);

  const upcoming = [];
  const history = [];

  list.forEach(ap=>{
    const d = new Date(ap.date+"T00:00:00");
    if(d >= today && ap.status!=="cancelled" && ap.status!=="rejected"){
      upcoming.push(ap);
    }else history.push(ap);
  });

  renderUpcoming(upcoming);
  renderHistory(history);
}

function renderUpcoming(arr){
  upcomingList.innerHTML="";

  if(arr.length===0){
    upcomingList.textContent="Yaklaşan randevu yok.";
    return;
  }

  arr.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

  arr.forEach(ap=>{
    const div=document.createElement("div");
    div.className="appt";

    div.innerHTML=`
      <div class="appt-title">${ap.businessID}</div>
      <div>${ap.date} · ${ap.time}</div>
      <span class="status ${ap.status}">${statusText(ap.status)}</span>
      <button class="small-btn">İptal</button>
    `;

    div.querySelector("button").onclick = ()=> updateDoc(doc(db,"appointments",ap.id),{
      status:"cancelled"
    });

    upcomingList.appendChild(div);
  });
}

function renderHistory(arr){
  historyList.innerHTML="";

  if(arr.length===0){
    historyList.textContent="Geçmiş randevu yok.";
    return;
  }

  arr.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));

  arr.forEach(ap=>{
    const div=document.createElement("div");
    div.className="appt";

    div.innerHTML=`
      <div class="appt-title">${ap.businessID}</div>
      <div>${ap.date} · ${ap.time}</div>
      <span class="status ${ap.status}">${statusText(ap.status)}</span>
    `;

    historyList.appendChild(div);
  });
}

function statusText(s){
  return s==="pending" ? "Onay Bekliyor" :
         s==="approved" ? "Onaylandı" :
         s==="rejected" ? "Reddedildi" :
         s==="cancelled" ? "İptal Edildi" : s;
}

/* --------------------------------------------------------------------
     OneSignal PlayerID Kaydı
-------------------------------------------------------------------- */
async function savePlayerID(){
  window.OneSignalDeferred.push(async function(OneSignal){
    const pid = await OneSignal.User.getId();
    if(pid){
      await updateDoc(doc(db,"customers",uid), { playerID:pid });
    }
  });
}

/* --------------------------------------------------------------------
     Bildirim: 15 gün sonra hatırlatıcı
-------------------------------------------------------------------- */
reminderBtn.onclick = async()=>{
  const ref = doc(db,"customers",uid);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;

  const c = snap.data();
  if(!c.playerID){
    alert("Bildirim izni vermen gerekiyor.");
    return;
  }

  const in15 = new Date(Date.now() + 15*24*60*60*1000);

  await fetch("https://onesignal.com/api/v1/notifications",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"os_v2_app_pbglu5agqne63i6g5btud7dk5ykwltjp5bsurlevniaotnezguucqagszcnwvmprawyc6pl7egsftoxdww3dspjn2bmutgby2gdbmli"
    },
    body:JSON.stringify({
      app_id:"784cba74-0683-49ed-a3c6-e86741fc6aee",
      include_player_ids:[c.playerID],
      send_after: in15.toISOString(),
      headings:{tr:"Yeni randevu zamanı"},
      contents:{tr:"15 gün oldu. Yeni bir randevu oluşturmak ister misin?"}
    })
  });

  reminderInfo.textContent="Hatırlatıcı ayarlandı: "+ in15.toLocaleDateString("tr-TR");
};

/* --------------------------------------------------------------------
     ÇIKIŞ
-------------------------------------------------------------------- */
logoutBtn.onclick = async()=>{
  await signOut(auth);
  location.href="customer-login.html";
};

</script>

</body>
</html>

