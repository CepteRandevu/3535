<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Müşteri Paneli | Cepterandevu</title>

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --card-soft:#020617;
      --text:#f8fafc;
      --muted:#94a3b8;
      --accent:#22c55e;
      --accent-strong:#16a34a;
      --danger:#ef4444;
      --border:rgba(148,163,184,0.4);
      --radius-lg:18px;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.85);
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:radial-gradient(circle at top,#111827,#020617 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px 12px 32px;
    }

    .app{
      width:100%;
      max-width:900px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
    }
    .logo-mark{
      width:32px;height:32px;border-radius:14px;
      background:radial-gradient(circle at 30% 10%,#4ade80,#16a34a 42%,#0f766e);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:800;color:#ecfdf5;
      box-shadow:0 10px 30px rgba(34,197,94,0.6);
    }
    .logo-text-main{font-weight:600;font-size:16px;}
    .logo-text-sub{font-size:11px;color:var(--muted);}

    .logout-btn{
      border:0;border-radius:999px;
      padding:7px 14px;font-size:12px;cursor:pointer;
      background:var(--danger);color:#fff;font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.2fr);
      gap:16px;
    }
    @media(max-width:780px){ .grid{grid-template-columns:minmax(0,1fr);} }

    .card{
      background:rgba(15,23,42,0.96);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      padding:16px;
      margin-bottom:16px;
    }

    /* --- PROFIL FOTO YENİ SİSTEM (işletmedeki kaliteyle aynı) --- */
    .pfp-wrap{
      display:flex;flex-direction:column;align-items:center;gap:8px;
    }
    .pfp{
      width:120px;height:120px;border-radius:999px;
      object-fit:cover;object-position:center;
      background:#020617;border:2px solid var(--accent);
    }
    .pfp-btn{
      padding:7px 14px;border-radius:12px;border:0;
      cursor:pointer;font-size:12px;font-weight:600;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;box-shadow:0 8px 18px rgba(34,197,94,0.35);
    }
    /* ---------------------------------------------------------- */

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px;}
    input{
      width:100%;padding:9px 11px;border-radius:12px;
      border:1px solid rgba(148,163,184,0.35);
      background:#020617;color:var(--text);font-size:13px;margin-bottom:10px;
      outline:none;
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent);}

    .btn-primary{
      width:100%;padding:10px 12px;border-radius:12px;border:0;
      cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      color:#022c22;font-weight:600;font-size:14px;
      box-shadow:0 12px 28px rgba(34,197,94,0.4);margin-top:4px;
    }

    .appt{
      background:var(--card-soft);border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      padding:11px;margin-bottom:8px;font-size:12px;
    }
    .status{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;margin-top:5px;}
    .status.pending{background:rgba(234,179,8,0.2);color:#facc15;}
    .status.approved{background:rgba(34,197,94,0.2);color:#4ade80;}
    .status.rejected{background:rgba(239,68,68,0.2);color:#ef4444;}
    .status.cancelled{background:rgba(148,163,184,0.2);color:#e5e7eb;}
    .small-btn{
      padding:5px 10px;border-radius:10px;border:0;font-size:11px;cursor:pointer;
      background:var(--danger);color:#fff;margin-top:6px;
    }

  </style>

</head>
<body>

<div class="app">

  <header>
    <div class="logo" id="homeLogo">
      <div class="logo-mark">C</div>
      <div>
        <div class="logo-text-main">Cepterandevu</div>
        <div class="logo-text-sub">Müşteri Paneli</div>
      </div>
    </div>
    <button id="logoutBtn" class="logout-btn">Çıkış Yap</button>
  </header>

  <main class="grid">

    <!-- PROFİL -->
    <section>
      <div class="card">
        <h2>Profilim</h2>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">Bilgilerini güncel tut.</div>

        <div class="profile-layout" style="display:flex;gap:14px;align-items:flex-start;">
          <div class="pfp-wrap">
            <img id="pfp" class="pfp" src="">
            <button id="choosePhotoBtn" class="pfp-btn">Fotoğraf Seç</button>
            <input id="photoInput" type="file" accept="image/*" style="display:none;">
          </div>

          <div style="flex:1;">
            <div class="profile-info-row"><span style="color:var(--muted)">Ad Soyad:</span> <span id="pName">-</span></div>
            <div class="profile-info-row"><span style="color:var(--muted)">Telefon:</span> <span id="pPhone">-</span></div>
            <div class="profile-info-row"><span style="color:var(--muted)">Üyelik Tarihi:</span> <span id="pJoin">-</span></div>

            <div style="margin-top:10px;">
              <label>Ad Soyad</label>
              <input id="editName" type="text">

              <label>Yeni Şifre (opsiyonel)</label>
              <input id="editPassword" type="password" placeholder="Boş bırakırsan değişmez">

              <button id="saveProfileBtn" class="btn-primary">Profili Kaydet</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Hatırlatıcı -->
      <div class="card">
        <h2>Hatırlatıcı</h2>
        <button id="reminderBtn" class="btn-primary" style="background:#020617;border:1px solid var(--border);color:var(--text);">15 gün sonra hatırlat</button>
        <div id="reminderInfo" style="font-size:12px;color:var(--muted);margin-top:6px;"></div>
      </div>
    </section>

    <!-- RANDEVULAR -->
    <section>
      <div class="card">
        <h2>Yaklaşan Randevularım</h2>
        <div id="upcomingList">Yükleniyor...</div>
      </div>

      <div class="card">
        <h2>Geçmiş Randevularım</h2>
        <div id="historyList">Yükleniyor...</div>
      </div>
    </section>

  </main>
</div>


<script type="module">
  import { firebaseConfig } from "./js/firebase-config.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, updateDoc, collection, query,
    where, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signOut, updatePassword
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUID = null;

  const pfpEl = document.getElementById("pfp");
  const choosePhotoBtn = document.getElementById("choosePhotoBtn");
  const photoInput = document.getElementById("photoInput");

  const pNameEl = document.getElementById("pName");
  const pPhoneEl = document.getElementById("pPhone");
  const pJoinEl = document.getElementById("pJoin");

  const editNameInput = document.getElementById("editName");
  const editPasswordInput = document.getElementById("editPassword");
  const saveProfileBtn = document.getElementById("saveProfileBtn");

  const upcomingList = document.getElementById("upcomingList");
  const historyList = document.getElementById("historyList");

  const reminderBtn = document.getElementById("reminderBtn");
  const reminderInfo = document.getElementById("reminderInfo");


  /* ---------------- LOGO → ANASAYFA ---------------- */
  document.getElementById("homeLogo").addEventListener("click", ()=>{
    window.location.href = "https://cepterandevu.github.io/al/";
  });


  /* ---------------- BASE64 DÖNÜŞTÜR (GÜÇLENDİRİLMİŞ) ---------------- */
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }


  /* ---------------- AUTH KONTROL ---------------- */
  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      location.href = "customer-login.html";
      return;
    }
    currentUID = user.uid;
    await loadProfile();
    listenAppointmentsRealtime();
  });


  /* ---------------- PROFİL YÜKLE ---------------- */
  async function loadProfile(){
    const ref = doc(db,"customers",currentUID);
    const snap = await getDoc(ref);

    if(!snap.exists()){
      pNameEl.textContent="-";
      pPhoneEl.textContent="-";
      pJoinEl.textContent="-";
      pfpEl.src="https://cdn-icons-png.flaticon.com/512/149/149071.png";
      return;
    }

    const d = snap.data();

    pNameEl.textContent = d.name || "-";
    pPhoneEl.textContent = d.phone || "-";

    if(d.createdAt?.toDate){
      pJoinEl.textContent = d.createdAt.toDate().toLocaleDateString("tr-TR");
    }

    if(d.photoBase64){
      pfpEl.src = d.photoBase64;
    } else {
      pfpEl.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    }

    editNameInput.value = d.name || "";
  }


  /* ---------------- FOTOĞRAF SEÇ → BASE64 → FIRESTORE (İŞLETME PANELİ STİLİ) ---------------- */
  choosePhotoBtn.addEventListener("click", ()=> photoInput.click());

  photoInput.addEventListener("change", async()=>{
    const file = photoInput.files[0];
    if(!file) return;

    choosePhotoBtn.textContent = "Yükleniyor...";
    choosePhotoBtn.disabled = true;

    try{
      const base64 = await fileToBase64(file);

      // Firestore’a kaydet
      await updateDoc(doc(db,"customers",currentUID),{
        photoBase64: base64
      });

      // Ön izleme hemen değişir
      pfpEl.src = base64;

      choosePhotoBtn.textContent = "Fotoğrafı Değiştir";
    }catch(e){
      alert("Fotoğraf yükleme hatası oluştu.");
      choosePhotoBtn.textContent = "Tekrar Dene";
    }finally{
      choosePhotoBtn.disabled = false;
    }
  });


  /* ---------------- PROFİL KAYDET ---------------- */
  saveProfileBtn.addEventListener("click", async()=>{
    const newName = editNameInput.value.trim();
    const newPass = editPasswordInput.value;

    saveProfileBtn.disabled = true;

    try{
      if(newName){
        await updateDoc(doc(db,"customers",currentUID),{ name:newName });
      }

      if(newPass){
        if(newPass.length < 6){
          alert("Şifre en az 6 karakter olmalı.");
          saveProfileBtn.disabled = false;
          return;
        }
        await updatePassword(auth.currentUser,newPass);
      }

      alert("Profil güncellendi.");
      await loadProfile();
    }catch(e){
      alert("Profil güncellenemedi.");
    }finally{
      saveProfileBtn.disabled = false;
    }
  });


  /* ---------------- RANDEVULAR ---------------- */
  function listenAppointmentsRealtime(){
    const q = query(collection(db,"appointments"), where("customerUID","==",currentUID));

    onSnapshot(q, async(snap)=>{
      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));

      const today = new Date();
      today.setHours(0,0,0,0);

      const upcoming=[];
      const history=[];

      for(const ap of list){
        const dt = new Date(ap.date+"T00:00:00");

        if(dt >= today && ap.status !== "cancelled" && ap.status !== "rejected"){
          upcoming.push(ap);
        }else{
          history.push(ap);
        }
      }

      renderUpcoming(upcoming);
      renderHistory(history);
    });
  }

  function renderUpcoming(arr){
    if(arr.length===0){
      upcomingList.textContent = "Yaklaşan randevu yok.";
      return;
    }

    upcomingList.innerHTML = "";
    arr.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

    arr.forEach(ap=>{
      const div = document.createElement("div");
      div.className="appt";
      div.innerHTML = `
        <div class="appt-title">${ap.businessName || ap.businessID}</div>
        <div class="appt-line">${ap.serviceName || ap.serviceID} · ${ap.employeeName || ap.employeeID}</div>
        <div class="appt-line">${ap.date} · ${ap.time}</div>
        <span class="status ${ap.status}">${ap.status}</span>
      `;

      if(ap.status!=="cancelled"){
        const btn=document.createElement("button");
        btn.className="small-btn";
        btn.textContent="Randevuyu İptal Et";
        btn.onclick= ()=> cancelAppointment(ap.id);
        div.appendChild(btn);
      }

      upcomingList.appendChild(div);
    });
  }

  function renderHistory(arr){
    if(arr.length===0){
      historyList.textContent = "Geçmiş randevu yok.";
      return;
    }

    historyList.innerHTML = "";
    arr.sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time));

    arr.forEach(ap=>{
      const div = document.createElement("div");
      div.className="appt";
      div.innerHTML = `
        <div class="appt-title">${ap.businessName || ap.businessID}</div>
        <div class="appt-line">${ap.serviceName || ap.serviceID} · ${ap.employeeName || ap.employeeID}</div>
        <div class="appt-line">${ap.date} · ${ap.time}</div>
        <span class="status ${ap.status}">${ap.status}</span>
      `;
      historyList.appendChild(div);
    });
  }

  async function cancelAppointment(id){
    if(!confirm("Bu randevuyu iptal etmek istediğine emin misin?")) return;
    await updateDoc(doc(db,"appointments",id),{ status:"cancelled" });
    alert("Randevu iptal edildi.");
  }

  /* ---------------- ÇIKIŞ ---------------- */
  document.getElementById("logoutBtn").addEventListener("click", async()=>{
    await signOut(auth);
    window.location.href="customer-login.html";
  });

</script>

</body>
</html>
